<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFM Quoting App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
        }
        .container {
            max-width: 100%;
            padding: 1rem;
        }
        @media (min-width: 768px) {
            .container {
                max-width: 600px; /* Constrain width on larger screens */
            }
        }
        .modal-overlay {
            background-color: rgba(0, 0, 0, 0.6);
            z-index: 999;
        }
        .modal-content {
            max-height: 90vh; /* Limit modal height */
            overflow-y: auto; /* Enable scrolling for long content */
        }
        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(1); /* Adjust calendar icon color for dark backgrounds if needed */
        }
        /* Custom scrollbar for modals */
        .modal-content::-webkit-scrollbar {
            width: 8px;
        }
        .modal-content::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        .modal-content::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white p-4 shadow-lg sticky top-0 z-10">
        <div class="container mx-auto flex items-center justify-between">
            <h1 class="text-2xl font-bold">IFM Quoting App</h1>
            <button id="backButton" class="hidden bg-blue-700 hover:bg-blue-900 text-white font-semibold py-2 px-4 rounded-full shadow-md transition duration-300 ease-in-out">
                Back
            </button>
        </div>
    </header>

    <main id="app-container" class="flex-grow container mx-auto p-4">
        <!-- Content will be dynamically loaded here -->
        <div id="loading-spinner" class="hidden fixed inset-0 flex items-center justify-center bg-gray-800 bg-opacity-75 z-[1000]">
            <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
            <p class="text-white ml-4 text-lg">Loading...</p>
        </div>

        <!-- Projects List View -->
        <section id="projects-view" class="space-y-4 fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Your Quotes</h2>
            <button id="addProjectBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 ease-in-out hover:scale-105">
                + Add New Quote
            </button>
            <div id="projectsList" class="grid grid-cols-1 gap-4 mt-6">
                <!-- Projects will be loaded here -->
            </div>
        </section>

        <!-- Sites List View -->
        <section id="sites-view" class="hidden space-y-4 fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Sites for <span id="currentProjectName" class="text-blue-600"></span></h2>
            <button id="addSiteBtn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 ease-in-out hover:scale-105">
                + Add New Site
            </button>
            <div id="sitesList" class="grid grid-cols-1 gap-4 mt-6">
                <!-- Sites will be loaded here -->
            </div>
        </section>

        <!-- Zones List View -->
        <section id="zones-view" class="hidden space-y-4 fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Zones for <span id="currentSiteName" class="text-blue-600"></span></h2>
            <button id="addZoneBtn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 ease-in-out hover:scale-105">
                + Add New Zone
            </button>
            <div id="zonesList" class="grid grid-cols-1 gap-4 mt-6">
                <!-- Zones will be loaded here -->
            </div>
        </section>

        <!-- Services List View -->
        <section id="services-view" class="hidden space-y-4 fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Services for <span id="currentZoneName" class="text-blue-600"></span></h2>
            <button id="addServiceBtn" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 ease-in-out hover:scale-105">
                + Add New Service
            </button>
            <div id="servicesList" class="grid grid-cols-1 gap-4 mt-6">
                <!-- Services will be loaded here -->
            </div>
        </section>

        <!-- Service Detail View -->
        <section id="service-detail-view" class="hidden space-y-4 fade-in">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">Service Details: <span id="currentServiceTypeName" class="text-blue-600"></span></h2>
            <form id="serviceDetailForm" class="bg-white p-6 rounded-lg shadow-md space-y-4">
                <div id="dynamicServiceFields">
                    <!-- Dynamic fields will be loaded here based on service type -->
                </div>

                <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-4">Notes</h3>
                <div>
                    <label for="serviceNote" class="block text-gray-700 font-semibold mb-2">Add any comments here</label>
                    <textarea id="serviceNote" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="4"></textarea>
                </div>

                <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-4">Service Images</h3>
                <input type="file" id="serviceImageInput" accept="image/*" capture="camera" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div id="serviceImagesPreview" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mt-4">
                    <!-- Image previews will be loaded here -->
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 ease-in-out hover:scale-105">
                    Save Service Details
                </button>
                <button type="button" id="deleteServiceBtn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transform transition duration-300 ease-in-out hover:scale-105 mt-2">
                    Delete Service
                </button>
            </form>
        </section>
    </main>

    <!-- Modals -->

    <!-- Project Modal -->
    <div id="projectModal" class="fixed inset-0 hidden items-center justify-center modal-overlay">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3 modal-content fade-in">
            <h3 class="text-2xl font-bold text-gray-800 mb-4" id="projectModalTitle">Add New Quote</h3>
            <form id="projectForm" class="space-y-4">
                <div>
                    <label for="projectName" class="block text-gray-700 font-semibold mb-2">Quote Name</label>
                    <input type="text" id="projectName" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="projectClient" class="block text-gray-700 font-semibold mb-2">Client Name</label>
                    <input type="text" id="projectClient" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="clientCategory" class="block text-gray-700 font-semibold mb-2">Client Category</label>
                    <select id="clientCategory" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Category</option>
                        <option value="Industrial">Industrial</option>
                        <option value="Commercial">Commercial</option>
                        <option value="Healthcare">Healthcare</option>
                        <option value="District Energy">District Energy</option>
                    </select>
                </div>
                <div id="clientSubcategoryGroup" class="hidden">
                    <label for="clientSubcategory" class="block text-gray-700 font-semibold mb-2">Client Subcategory</label>
                    <select id="clientSubcategory" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Subcategory</option>
                    </select>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancelProjectBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">Save Quote</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Site Modal -->
    <div id="siteModal" class="fixed inset-0 hidden items-center justify-center modal-overlay">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-2/3 lg:w-1/2 modal-content fade-in"> <!-- Increased width for more content -->
            <h3 class="text-2xl font-bold text-gray-800 mb-4" id="siteModalTitle">Add New Site</h3>
            <form id="siteForm" class="space-y-4">
                <!-- Existing fields -->
                <div>
                    <label for="siteName" class="block text-gray-700 font-semibold mb-2">Site Name</label>
                    <input type="text" id="siteName" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="siteAddress" class="block text-gray-700 font-semibold mb-2">Address</label>
                    <input type="text" id="siteAddress" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="siteTotalSqFt" class="block text-gray-700 font-semibold mb-2">Total Square Footage</label>
                    <input type="number" id="siteTotalSqFt" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="sitePersonnelShifts" class="block text-gray-700 font-semibold mb-2">Personnel Shifts & Hours</label>
                    <textarea id="sitePersonnelShifts" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                </div>

                <!-- New: Maintenance Strategy Section -->
                <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-4 border-b pb-2">Maintenance Strategy</h3>
                <div>
                    <label for="ppmRmSplitCurrent" class="block text-gray-700 font-semibold mb-2">Current PPM/RM Split (e.g., 70% Planned, 30% Reactive)</label>
                    <input type="text" id="ppmRmSplitCurrent" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="ppmRmSplitProposed" class="block text-gray-700 font-semibold mb-2">Proposed PPM/RM Split (e.g., 85% Planned, 15% Reactive)</label>
                    <input type="text" id="ppmRmSplitProposed" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="detailedSLAs" class="block text-gray-700 font-semibold mb-2">Detailed SLAs (e.g., Critical: 1-hour response, 4-hour resolution)</label>
                    <textarea id="detailedSLAs" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                </div>
                <div>
                    <label for="clientPriorityPainPoints" class="block text-gray-700 font-semibold mb-2">Client Priority / Pain Points</label>
                    <textarea id="clientPriorityPainPoints" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                </div>
                <div>
                    <label for="complianceRequirements" class="block text-gray-700 font-semibold mb-2">Compliance Requirements (e.g., Annual fire system inspection)</label>
                    <textarea id="complianceRequirements" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" rows="3"></textarea>
                </div>

                <!-- New: Asset Register Section -->
                <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-4 border-b pb-2">Asset Register</h3>
                <button type="button" id="addAssetBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-sm mb-4">
                    + Add New Asset
                </button>
                <div id="assetsList" class="space-y-3">
                    <!-- Assets will be loaded here -->
                </div>

                <!-- Existing Site Images -->
                <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-4">Site Images</h3>
                <input type="file" id="siteImageInput" accept="image/*" capture="camera" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div id="siteImagesPreview" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mt-4">
                    <!-- Image previews will be loaded here -->
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancelSiteBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">Cancel</button>
                    <button type="submit" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">Save Site</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Zone Modal -->
    <div id="zoneModal" class="fixed inset-0 hidden items-center justify-center modal-overlay">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3 modal-content fade-in">
            <h3 class="text-2xl font-bold text-gray-800 mb-4" id="zoneModalTitle">Add New Zone</h3>
            <form id="zoneForm" class="space-y-4">
                <div>
                    <label for="zoneName" class="block text-gray-700 font-semibold mb-2">Zone Name</label>
                    <input type="text" id="zoneName" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="zoneSqFt" class="block text-gray-700 font-semibold mb-2">Zone Square Footage</label>
                    <input type="number" id="zoneSqFt" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label for="zoneFunction" class="block text-gray-700 font-semibold mb-2">Zone Function</label>
                    <select id="zoneFunction" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Function</option>
                        <option value="Office">Office</option>
                        <option value="Production">Production</option>
                        <option value="Warehouse">Warehouse</option>
                        <option value="Parking">Parking</option>
                        <option value="Technical Room">Technical Room</option>
                        <option value="Server Room">Server Room</option>
                        <option value="Laboratory">Laboratory</option>
                        <option value="Cleanroom">Cleanroom</option>
                        <option value="Restroom">Restroom</option>
                        <option value="Cafeteria">Cafeteria</option>
                        <option value="Common Area">Common Area</option>
                        <option value="Exterior">Exterior</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <h3 class="text-xl font-semibold text-gray-700 mt-6 mb-4">Zone Images</h3>
                <input type="file" id="zoneImageInput" accept="image/*" capture="camera" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <div id="zoneImagesPreview" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 mt-4">
                    <!-- Image previews will be loaded here -->
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancelZoneBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">Cancel</button>
                    <button type="submit" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">Save Zone</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Service Modal -->
    <div id="serviceModal" class="fixed inset-0 hidden items-center justify-center modal-overlay">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3 modal-content fade-in">
            <h3 class="text-2xl font-bold text-gray-800 mb-4" id="serviceModalTitle">Add New Service</h3>
            <form id="serviceForm" class="space-y-4">
                <div>
                    <label for="serviceType" class="block text-gray-700 font-semibold mb-2">Service Type</label>
                    <select id="serviceType" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>
                        <option value="">Select a service type</option>
                        <!-- Options will be dynamically loaded from SERVICE_DEFINITIONS -->
                    </select>
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancelServiceBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">Cancel</button>
                    <button type="submit" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">Add Service</button>
                </div>
            </form>
        </div>
    </div>

    <!-- New: Asset Modal -->
    <div id="assetModal" class="fixed inset-0 hidden items-center justify-center modal-overlay">
        <div class="bg-white p-8 rounded-lg shadow-xl w-11/12 md:w-1/2 lg:w-1/3 modal-content fade-in">
            <h3 class="text-2xl font-bold text-gray-800 mb-4" id="assetModalTitle">Add New Asset</h3>
            <form id="assetForm" class="space-y-4">
                <div>
                    <label for="assetType" class="block text-gray-700 font-semibold mb-2">Asset Type</label>
                    <input type="text" id="assetType" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required placeholder="e.g., HVAC Unit, Chiller, Electrical Panel">
                </div>
                <div>
                    <label for="assetQuantity" class="block text-gray-700 font-semibold mb-2">Quantity</label>
                    <input type="number" id="assetQuantity" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required value="1">
                </div>
                <div>
                    <label for="assetLocation" class="block text-gray-700 font-semibold mb-2">Location (Zone/Room)</label>
                    <input type="text" id="assetLocation" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Zone A, Server Room">
                </div>
                <div>
                    <label for="assetCriticality" class="block text-gray-700 font-semibold mb-2">Criticality</label>
                    <select id="assetCriticality" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Criticality</option>
                        <option value="High">High</option>
                        <option value="Medium">Medium</option>
                        <option value="Low">Low</option>
                    </select>
                </div>
                <div>
                    <label for="assetCondition" class="block text-gray-700 font-semibold mb-2">Condition</label>
                    <select id="assetCondition" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select Condition</option>
                        <option value="New">New</option>
                        <option value="Good">Good</option>
                        <option value="Fair">Fair</option>
                        <option value="Poor">Poor</option>
                    </select>
                </div>
                <div>
                    <label for="assetManufacturerModel" class="block text-gray-700 font-semibold mb-2">Manufacturer / Model</label>
                    <input type="text" id="assetManufacturerModel" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="e.g., Carrier 30XA, IBM Power9">
                </div>
                <div>
                    <label for="assetInstallationDate" class="block text-gray-700 font-semibold mb-2">Installation Date</label>
                    <input type="date" id="assetInstallationDate" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="assetLastServiceDate" class="block text-gray-700 font-semibold mb-2">Last Service Date</label>
                    <input type="date" id="assetLastServiceDate" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label for="assetNextDueDate" class="block text-gray-700 font-semibold mb-2">Next Due Date</label>
                    <input type="date" id="assetNextDueDate" class="w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="flex justify-end space-x-4">
                    <button type="button" id="cancelAssetBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">Cancel</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">Save Asset</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Message Box Modal -->
    <div id="messageBox" class="fixed inset-0 hidden items-center justify-center modal-overlay">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/3 text-center fade-in">
            <p id="messageBoxText" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <button id="messageBoxOkBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">OK</button>
        </div>
    </div>

    <!-- Custom Confirmation Box Modal -->
    <div id="confirmationBox" class="fixed inset-0 hidden items-center justify-center modal-overlay">
        <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 md:w-1/3 text-center fade-in">
            <p id="confirmationBoxText" class="text-lg font-semibold text-gray-800 mb-4"></p>
            <div class="flex justify-center space-x-4">
                <button id="confirmationBoxCancelBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">Cancel</button>
                <button id="confirmationBoxConfirmBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-md transition duration-300 ease-in-out">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase variables (provided by Canvas environment)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Initialize Firebase
        let app, db, auth, userId = null;
        let isAuthReady = false;

        // UI Elements
        const loadingSpinner = document.getElementById('loading-spinner');
        const backButton = document.getElementById('backButton');

        // Views
        const projectsView = document.getElementById('projects-view');
        const sitesView = document.getElementById('sites-view');
        const zonesView = document.getElementById('zones-view');
        const servicesView = document.getElementById('services-view');
        const serviceDetailView = document.getElementById('service-detail-view');

        // Lists
        const projectsList = document.getElementById('projectsList');
        const sitesList = document.getElementById('sitesList');
        const zonesList = document.getElementById('zonesList');
        const servicesList = document.getElementById('servicesList');

        // Buttons
        const addProjectBtn = document.getElementById('addProjectBtn');
        const addSiteBtn = document.getElementById('addSiteBtn');
        const addZoneBtn = document.getElementById('addZoneBtn');
        const addServiceBtn = document.getElementById('addServiceBtn');
        const deleteServiceBtn = document.getElementById('deleteServiceBtn');

        // Modals
        const projectModal = document.getElementById('projectModal');
        const projectModalTitle = document.getElementById('projectModalTitle');
        const projectForm = document.getElementById('projectForm');
        const projectNameInput = document.getElementById('projectName');
        const projectClientInput = document.getElementById('projectClient');
        const clientCategorySelect = document.getElementById('clientCategory');
        const clientSubcategoryGroup = document.getElementById('clientSubcategoryGroup');
        const clientSubcategorySelect = document.getElementById('clientSubcategory');
        const cancelProjectBtn = document.getElementById('cancelProjectBtn');

        const siteModal = document.getElementById('siteModal');
        const siteModalTitle = document.getElementById('siteModalTitle');
        const siteForm = document.getElementById('siteForm');
        const siteNameInput = document.getElementById('siteName');
        const siteAddressInput = document.getElementById('siteAddress');
        const siteTotalSqFtInput = document.getElementById('siteTotalSqFt');
        const sitePersonnelShiftsInput = document.getElementById('sitePersonnelShifts');
        const siteImageInput = document.getElementById('siteImageInput'); // New site image input
        const siteImagesPreview = document.getElementById('siteImagesPreview'); // New site image preview
        const cancelSiteBtn = document.getElementById('cancelSiteBtn');

        // Site Modal - New Maintenance Strategy Fields
        const ppmRmSplitCurrentInput = document.getElementById('ppmRmSplitCurrent');
        const ppmRmSplitProposedInput = document.getElementById('ppmRmSplitProposed');
        const detailedSLAsInput = document.getElementById('detailedSLAs');
        const clientPriorityPainPointsInput = document.getElementById('clientPriorityPainPoints');
        const complianceRequirementsInput = document.getElementById('complianceRequirements');

        // Site Modal - Asset Register Elements
        const addAssetBtn = document.getElementById('addAssetBtn');
        const assetsList = document.getElementById('assetsList');

        const zoneModal = document.getElementById('zoneModal');
        const zoneModalTitle = document.getElementById('zoneModalTitle');
        const zoneForm = document.getElementById('zoneForm');
        const zoneNameInput = document.getElementById('zoneName');
        const zoneSqFtInput = document.getElementById('zoneSqFt');
        const zoneFunctionSelect = document.getElementById('zoneFunction');
        const zoneImageInput = document.getElementById('zoneImageInput'); // New zone image input
        const zoneImagesPreview = document.getElementById('zoneImagesPreview'); // New zone image preview
        const cancelZoneBtn = document.getElementById('cancelZoneBtn');

        const serviceModal = document.getElementById('serviceModal');
        const serviceModalTitle = document.getElementById('serviceModalTitle');
        const serviceForm = document.getElementById('serviceForm');
        const serviceTypeSelect = document.getElementById('serviceType');
        const cancelServiceBtn = document.getElementById('cancelServiceBtn');

        const serviceDetailForm = document.getElementById('serviceDetailForm');
        const dynamicServiceFields = document.getElementById('dynamicServiceFields');
        const serviceNoteInput = document.getElementById('serviceNote');
        const serviceImageInput = document.getElementById('serviceImageInput');
        const serviceImagesPreview = document.getElementById('serviceImagesPreview');

        const currentProjectNameSpan = document.getElementById('currentProjectName');
        const currentSiteNameSpan = document.getElementById('currentSiteName');
        const currentZoneNameSpan = document.getElementById('currentZoneName');
        const currentServiceTypeNameSpan = document.getElementById('currentServiceTypeName');

        // Asset Modal
        const assetModal = document.getElementById('assetModal');
        const assetModalTitle = document.getElementById('assetModalTitle');
        const assetForm = document.getElementById('assetForm');
        const assetTypeInput = document.getElementById('assetType');
        const assetQuantityInput = document.getElementById('assetQuantity');
        const assetLocationInput = document.getElementById('assetLocation');
        const assetCriticalitySelect = document.getElementById('assetCriticality');
        const assetConditionSelect = document.getElementById('assetCondition');
        const assetManufacturerModelInput = document.getElementById('assetManufacturerModel');
        const assetInstallationDateInput = document.getElementById('assetInstallationDate');
        const assetLastServiceDateInput = document.getElementById('assetLastServiceDate');
        const assetNextDueDateInput = document.getElementById('assetNextDueDate');
        const cancelAssetBtn = document.getElementById('cancelAssetBtn');

        // Custom Message Box
        const messageBox = document.getElementById('messageBox');
        const messageBoxText = document.getElementById('messageBoxText');
        const messageBoxOkBtn = document.getElementById('messageBoxOkBtn');

        // Custom Confirmation Box
        const confirmationBox = document.getElementById('confirmationBox');
        const confirmationBoxText = document.getElementById('confirmationBoxText');
        const confirmationBoxCancelBtn = document.getElementById('confirmationBoxCancelBtn');
        const confirmationBoxConfirmBtn = document.getElementById('confirmationBoxConfirmBtn');

        // App State
        const appState = {
            currentView: 'projects', // 'projects', 'sites', 'zones', 'services', 'service-detail'
            currentProjectId: null,
            currentProjectName: null,
            currentSiteId: null,
            currentSiteName: null,
            currentSitePictures: [], // New state for site pictures
            currentSiteAssets: [], // New state for assets within the current site
            currentEditingAssetIndex: null, // To track which asset is being edited
            currentZoneId: null,
            currentZoneName: null,
            currentZonePictures: [], // New state for zone pictures
            currentServiceId: null,
            currentServiceType: null,
            currentServiceData: {}, // Holds data for the service being edited
            currentServicePictures: [] // Holds pictures for the service being edited
        };

        // Client Categories and Subcategories Definition
        const CLIENT_CATEGORIES = {
            "Industrial": ["Mining", "Manufacturing", "Food and Beverage", "Pulp and Paper", "Petrochemical", "Data Center", "Other Industrial"],
            "Commercial": ["Office Building", "Retail", "Shopping Mall", "Hotel", "Convention Center", "Other Commercial"],
            "Healthcare": ["Hospital", "Clinic", "Medical Office", "Laboratory", "Long-Term Care", "Other Healthcare"],
            "District Energy": ["Central Plant", "Distribution Network", "Cogeneration Plant", "Other District Energy"]
        };

        // Service Definitions - comprehensive list of FM services and their required data fields
        const SERVICE_DEFINITIONS = {
            // Existing Services (Enhanced)
            "Cleaning": [
                { id: "areaSqFt", label: "Cleanable Area (Sq Ft)", type: "number", required: true },
                { id: "recurrence", label: "Cleaning Recurrence", type: "select", options: ["Daily", "Weekly", "Bi-Weekly", "Monthly", "Quarterly", "Annually"], required: true },
                { id: "standards", label: "Cleaning Standards", type: "select", options: ["Basic", "Standard", "High"], required: true },
                { id: "floorType", label: "Primary Floor Type", type: "text", placeholder: "e.g., Tile, Carpet, Hardwood" },
                { id: "wasteRemoval", label: "General Waste Removal Included", type: "checkbox" },
                { id: "wasteCollectionPoints", label: "Waste Collection Points (Centralized/Individual)", type: "text", placeholder: "e.g., Centralized, Individual Bins" },
                { id: "selectiveSortingProcedure", label: "Selective Sorting Procedure in Place", type: "checkbox" },
                { id: "garbageBagSize", label: "Garbage Bag Size/Caliber", type: "text", placeholder: "e.g., 30 gallon, 40L" },
                { id: "hazardousWasteCollection", label: "Hazardous Waste Collection by Equans", type: "checkbox" },
                { id: "windowCleaning", label: "Window Cleaning Included", type: "checkbox" },
                { id: "windowCleaningSurface", label: "Window Cleaning Surface (Sq Ft)", type: "number", dependsOn: "windowCleaning", required: false },
                { id: "windowCleaningInaccessible", label: "Inaccessible Window Cleaning Included", type: "checkbox", dependsOn: "windowCleaning" },
                { id: "windowCleaningElevationMeans", label: "Elevation Means for Inaccessible Windows", type: "text", dependsOn: "windowCleaningInaccessible", placeholder: "e.g., Pole, Boom Lift, Rope Access" },
                { id: "restroomCount", label: "Number of Restrooms", type: "number" },
                { id: "cleaningStorageRoom", label: "Cleaning Storage Room Details", type: "textarea", placeholder: "e.g., Centralized, accessible, equipped with outlets/shelves, elevators" },
                { id: "criticalZones", label: "Critical Cleaning Zones (with specific SOPs)", type: "textarea", placeholder: "e.g., Labs, Cleanrooms, Kitchens" },
                { id: "sanitaryConsumables", label: "Sanitary Consumables List/Brands", type: "textarea", placeholder: "e.g., Toilet paper (Tork), Hand soap (Diversey)" },
                { id: "cleaningEquipment", label: "Cleaning Equipment List/Brands", type: "textarea", placeholder: "e.g., Floor scrubber (Tennant), Vacuums (Nilfisk)" },
                { id: "entranceMatRotationFrequency", label: "Entrance Mat Rotation Frequency", type: "select", options: ["Daily", "Weekly", "Bi-Weekly", "Monthly", "Quarterly", "Annually"], required: false },
                { id: "entranceMatCountDimensions", label: "Entrance Mat Count & Dimensions", type: "textarea", placeholder: "e.g., 10 mats (3x5 ft)" },
                { id: "cleanerInterventionFrequency", label: "Cleaner Intervention Frequency (times/day)", type: "number", placeholder: "e.g., 3" },
                { id: "cleaningOrganization", label: "Cleaning Team Organization", type: "textarea", placeholder: "e.g., 1 Team Lead, 5 FTE, 2 shifts" }
            ],
            "HVAC Maintenance": [
                { id: "unitCount", label: "Unit Count", type: "number", required: true },
                { id: "type", label: "Type", type: "select", options: ["Split System", "Chiller", "Rooftop Unit", "Boiler", "Heat Pump", "VRF", "Other"], required: true },
                { id: "lastServiceDate", label: "Last Service Date", type: "date" },
                { id: "filterSize", label: "Filter Size", type: "text", placeholder: "e.g., 20x25x1" },
                { id: "frequency", label: "Maintenance Frequency", type: "select", options: ["Monthly", "Quarterly", "Bi-Annually", "Annually"], required: true },
                { id: "emergencyService", label: "Emergency Service Included", type: "checkbox" }
            ],
            "Fire Protection": [
                { id: "systemType", label: "System Type", type: "select", options: ["Sprinkler Dry", "Sprinkler Wet", "Standpipe", "Fire Alarm", "Extinguishers", "Suppression System", "Other"], required: true },
                { id: "sprinklerHeadCount", label: "Sprinkler Head Count", type: "number", dependsOn: "systemType", dependsOnValue: ["Sprinkler Dry", "Sprinkler Wet"] },
                { id: "extinguisherCount", label: "Extinguisher Count", type: "number", dependsOn: "systemType", dependsOnValue: ["Extinguishers"] },
                { id: "alarmSystemType", label: "Alarm System Type", type: "text", dependsOn: "systemType", dependsOnValue: ["Fire Alarm"], placeholder: "e.g., Addressable, Conventional" },
                { id: "lastInspectionDate", label: "Last Inspection Date", type: "date" },
                { id: "monitoring", label: "Monitoring Service Included", type: "checkbox" }
            ],
            "Plumbing Maintenance": [
                { id: "fixtureCount", label: "Fixture Count (Toilets, Sinks, etc.)", type: "number", required: true },
                { id: "pipeMaterial", label: "Primary Pipe Material", type: "text", placeholder: "e.g., Copper, PVC, Cast Iron" },
                { id: "drainageSystem", label: "Drainage System Type", type: "text", placeholder: "e.g., Gravity, Sump Pump" },
                { id: "waterHeaterCount", label: "Water Heater Count", type: "number" },
                { id: "backflowPreventer", label: "Backflow Preventer On-site", type: "checkbox" }
            ],
            "Electrical Maintenance": [
                { id: "panelCount", label: "Electrical Panel Count", type: "number", required: true },
                { id: "circuitCount", label: "Estimated Circuit Count", type: "number" },
                { id: "lightingType", label: "Primary Lighting Type", type: "text", placeholder: "e.g., LED, Fluorescent, Incandescent" },
                { id: "generator", label: "Generator On-site", type: "checkbox" },
                { id: "generatorCapacity", label: "Generator Capacity (kVA)", type: "number", dependsOn: "generator" },
                { id: "emergencyLighting", label: "Emergency Lighting System", type: "checkbox" }
            ],
            "Energy Management": [
                { id: "energyAudit", label: "Last Energy Audit Date", type: "date" },
                { id: "lightingUpgrade", label: "Lighting Upgrade Status", type: "select", options: ["Completed", "Planned", "None"] },
                { id: "BMS", label: "Building Management System (BMS) in place", type: "checkbox" },
                { id: "solarPanels", label: "Solar Panels On-site", type: "checkbox" },
                { id: "automatedEnergyManagementSystem", label: "Automated Energy Management System in place", type: "checkbox" },
                { id: "energyManagementSystemISO", label: "Energy Management System (ISO certified)", type: "text", placeholder: "e.g., ISO 50001, ISO 14001" }
            ],
            "Cleaning (Subcontracted)": [ // Renamed from "Cleaning" to avoid confusion, though user already has this.
                { id: "areaSqFt", label: "Area (Sq Ft)", type: "number", required: true },
                { id: "recurrence", label: "Recurrence", type: "select", options: ["Daily", "Weekly", "Bi-Weekly", "Monthly", "Quarterly", "Annually"], required: true },
                { id: "standards", label: "Standards", type: "select", options: ["Basic", "Standard", "High"], required: true },
                { id: "contractorName", label: "Subcontractor Name", type: "text" },
                { id: "contractDetails", label: "Contract Details", type: "textarea" }
            ],
            "Landscaping": [
                { id: "areaSqFt", label: "Landscaped Area (Sq Ft)", type: "number", required: true },
                { id: "frequency", label: "Service Frequency", type: "select", options: ["Weekly", "Bi-Weekly", "Monthly", "Quarterly", "Annually"], required: true },
                { id: "mowing", label: "Mowing Service Included", type: "checkbox" },
                { id: "pruning", label: "Pruning Service Included", type: "checkbox" },
                { id: "irrigation", label: "Irrigation System Present", type: "checkbox" },
                { id: "seasonalCleanup", label: "Seasonal Cleanup Included", type: "checkbox" },
                { id: "accessLimitations", label: "Machine Access Limitations", type: "textarea", placeholder: "e.g., Narrow gates, steep slopes" },
                { id: "interventionHours", label: "Possible Intervention Days & Hours", type: "textarea", placeholder: "e.g., Mon-Fri, 7 AM - 5 PM" },
                { id: "equipmentOwnership", label: "Equipment Ownership", type: "text", placeholder: "e.g., Client, Contractor" },
                { id: "electricalEquipmentMandatory", label: "Electrical Equipment Mandatory", type: "checkbox" },
                { id: "automaticWatering", label: "Automatic Watering System", type: "checkbox" },
                { id: "storageAreas", label: "Suitable & Secure Storage Areas", type: "checkbox" },
                { id: "specificRisks", label: "Specific Risks (Slopes, Water, Height, etc.)", type: "textarea", placeholder: "e.g., Steep slopes, pond near work area" },
                { id: "siteSpecificities", label: "Site Specificities (Flood Zone, Extreme Cold, etc.)", type: "textarea", placeholder: "e.g., Flood zone near river, extremely cold winters" },
                { id: "travelTimeConsideration", label: "Travel Time Needs Consideration (Large Site)", type: "checkbox" },
                { id: "adaptedVehicleNeeded", label: "Adapted Vehicle Needed", type: "checkbox", dependsOn: "travelTimeConsideration" },
                { id: "adaptedVehicleProvidedByClient", label: "Adapted Vehicle Provided by Client", type: "checkbox", dependsOn: "adaptedVehicleNeeded" },
                { id: "sustainableDevelopmentPlan", label: "Sustainable Development Plan in Place", type: "checkbox" },
                { id: "pesticideDocument", label: "Pesticide Use Document Available", type: "checkbox" },
                { id: "pesticideRegister", label: "Pesticide Register Available", type: "checkbox" },
                { id: "greenWasteManagement", label: "Green Waste Management Method", type: "textarea", placeholder: "e.g., Composted on-site, off-site disposal" },
                { id: "healthTrailMaintenance", label: "Health Trail Maintenance Details", type: "textarea", placeholder: "e.g., Synthetic turf, client responsible" },
                { id: "organizationDescription", label: "Grounds Team Organization", type: "textarea", placeholder: "e.g., 1 supervisor, 3 FTE" }
            ],
            "Recycling": [
                { id: "binCount", label: "Recycling Bin Count", type: "number", required: true },
                { id: "materialTypes", label: "Material Types Collected", type: "text", placeholder: "e.g., Paper, Plastic, Glass, Metal" },
                { id: "pickupFrequency", label: "Pickup Frequency", type: "select", options: ["Daily", "Weekly", "Bi-Weekly", "Monthly"], required: true }
            ],
            "Security": [
                { id: "mainFunction", label: "Main Function of Security Team", type: "select", options: ["Access Control", "Occupant Service", "Deterrence", "Health & Safety", "Other"], required: true },
                { id: "biggestRiskAsset", label: "Asset/Material with Biggest Risk", type: "text", placeholder: "e.g., Server Room, High-Value Inventory" },
                { id: "accessBadges", label: "Access Badges System", type: "checkbox" },
                { id: "videoSurveillance", label: "Video Surveillance System", type: "checkbox" },
                { id: "controlProcedures", label: "Control Procedures in place", type: "checkbox" },
                { id: "xRayMachines", label: "X-ray Machines Present", type: "checkbox" },
                { id: "intruderAlarm", label: "Intruder Alarm System", type: "checkbox" },
                { id: "parkingSurveillance", label: "Parking Surveillance", type: "checkbox" },
                { id: "fingerprintScanner", label: "Fingerprint Scanner Access", type: "checkbox" },
                { id: "accessDoorControl", label: "Access/Door Control System", type: "checkbox" },
                { id: "roundsManagementSoftware", label: "Rounds Management Software", type: "checkbox" },
                { id: "electronicSecurity", label: "Electronic Security Systems", type: "checkbox" },
                { id: "fireAlarmOthers", label: "Fire Alarm / Other Alarm Systems", type: "checkbox" },
                { id: "integratedSystemsBMS", label: "Integrated Systems / BMS", type: "checkbox" },
                { id: "highRiskAreas", label: "High-Risk Areas / Major Accident Hazards", type: "textarea", placeholder: "e.g., Hazardous substances storage, sensitive processes" },
                { id: "sitePerimeter", label: "Site Perimeter Status", type: "select", options: ["Open", "Closed / Fenced"], required: true },
                { id: "fenceType", label: "Fence Type", type: "select", options: ["Wire Mesh", "Welded Mesh", "Palisade", "Other"], dependsOn: "sitePerimeter", dependsOnValue: ["Closed / Fenced"] },
                { id: "gateType", label: "Gate Type", type: "text", dependsOn: "sitePerimeter", dependsOnValue: ["Closed / Fenced"], placeholder: "e.g., Sliding, Swing, Barrier" },
                { id: "vehicleBarrierClosureTime", label: "Vehicle Barrier Closure Time", type: "text", placeholder: "e.g., 6 PM" },
                { id: "vehicleBarrierType", label: "Vehicle Barrier Type", type: "text", placeholder: "e.g., Steel, Manual, Electronic" },
                { id: "pedestrianExitsCount", label: "Number of Pedestrian Exits", type: "number" },
                { id: "incidentsLast2Years", label: "Incidents in Last 2 Years (Theft, Intrusion, etc.)", type: "textarea", placeholder: "e.g., 2 thefts (Jan 2023, June 2024)" },
                { id: "keyManagementRole", label: "Security Role in Key Management", type: "textarea", placeholder: "e.g., Manage all keys, only specific service keys" },
                { id: "dailyRoundsSchedule", label: "Daily Rounds Schedule", type: "textarea", placeholder: "e.g., Every 2 hours, 15 min duration" },
                { id: "numberOfRounds", label: "Number of Rounds per Day", type: "number" },
                { id: "alarmTypes", label: "Types of Alarms on Site", type: "text", placeholder: "e.g., Intrusion, Fire, Panic" },
                { id: "numberOfAlarms", label: "Number of Alarms on Site", type: "number" },
                { id: "alarmProcessingTime", label: "Alarm Processing Time (minutes)", type: "number" },
                { id: "incidentManagementLevel", label: "Incident Management Level", type: "text", placeholder: "e.g., Tier 1, Full Management" },
                { id: "securityEquipmentList", label: "Security Equipment List & Ownership", type: "textarea", placeholder: "e.g., CCTV cameras (Client), Radios (Contractor)" },
                { id: "deliveryManagementRole", label: "Security Role in Delivery Management", type: "textarea", placeholder: "e.g., Check IDs, log deliveries, escort" },
                { id: "avgDailyDeliveries", label: "Average Daily Deliveries", type: "number" },
                { id: "securityOrganization", label: "Security Team Organization", type: "textarea", placeholder: "e.g., 1 Manager, 2 Supervisors, 10 Agents" },
                { id: "securityHoursPerFunction", label: "Security Hours Worked per Function", type: "textarea", placeholder: "e.g., Manager: 40 hrs/wk, Agent: 168 hrs/wk" },
                { id: "roundDuration", label: "Round Duration (hours)", type: "number", placeholder: "e.g., 8 or 12" }
            ],
            "Snow Removal": [
                { id: "areaSqFt", label: "Area for Snow Removal (Sq Ft)", type: "number", required: true },
                { id: "triggerDepth", label: "Trigger Depth (inches)", type: "number", placeholder: "e.g., 2" },
                { id: "salting", label: "Salting Service Included", type: "checkbox" },
                { id: "equipmentType", label: "Equipment Type Used", type: "text", placeholder: "e.g., Plow, Blower, Shovel" },
                { id: "deIcingSaltUse", label: "De-icing Salt Used", type: "checkbox" }
            ],
            "Roof Maintenance": [
                { id: "roofType", label: "Roof Type", type: "select", options: ["Flat", "Pitched", "Green Roof", "Metal", "Other"], required: true },
                { id: "material", label: "Roof Material", type: "text", placeholder: "e.g., TPO, EPDM, Asphalt Shingle" },
                { id: "inspectionFrequency", label: "Inspection Frequency", type: "select", options: ["Quarterly", "Bi-Annually", "Annually"], required: true },
                { id: "leakHistory", label: "Leak History (past 2 years)", type: "checkbox" }
            ],
            "Janitorial": [
                { id: "staffCount", label: "Number of Janitorial Staff", type: "number", required: true },
                { id: "hoursPerDay", label: "Hours per Day per Staff", type: "number", required: true },
                { id: "supplyManagement", label: "Supply Management Included", type: "checkbox" },
                { id: "specializedCleaning", label: "Specialized Cleaning (e.g., Floor Buffing)", type: "textarea", placeholder: "e.g., Floor buffing (monthly), carpet cleaning (quarterly)" }
            ],
            "Pest Control": [
                { id: "frequency", label: "Service Frequency", type: "select", options: ["Monthly", "Quarterly", "Bi-Annually", "Annually"], required: true },
                { id: "pestTypes", label: "Common Pest Types", type: "text", placeholder: "e.g., Rodents, Insects, Birds" },
                { id: "inspectionAreas", label: "Inspection Areas", type: "textarea", placeholder: "e.g., Kitchen, Storage, Exterior" },
                { id: "deviceVolume", label: "Volume of Devices (Traps, Bait Stations)", type: "number", placeholder: "e.g., 50" }
            ],
            "Waste Management": [
                { id: "containerCount", label: "Container Count", type: "number", required: true },
                { id: "containerSize", label: "Container Size (cu yd)", type: "number" },
                { id: "pickupFrequency", label: "Pickup Frequency", type: "select", options: ["Daily", "Weekly", "Bi-Weekly", "Monthly"], required: true },
                { id: "wasteType", label: "Primary Waste Type", type: "text", placeholder: "e.g., General, Hazardous, Organic" },
                { id: "wasteTypesManaged", label: "Detailed Waste Types Managed & Volume/Weight", type: "textarea", placeholder: "e.g., DIB: 10m3/day, Cardboard: 500kg/month, Hazardous (Code: 1234): 100kg/year" },
                { id: "customerPlannedChanges", label: "Customer Planned Changes Impacting Waste Volume", type: "checkbox" },
                { id: "wasteSortingCarriedOut", label: "Waste Sorting Carried Out", type: "checkbox" },
                { id: "sortedWasteTypes", label: "Types of Waste Sorted", type: "textarea", dependsOn: "wasteSortingCarriedOut", placeholder: "e.g., Paper, Plastic, Glass" },
                { id: "unsortedWastePotential", label: "Unsorted Waste with Sorting Potential", type: "textarea", placeholder: "e.g., Coffee cups, batteries, toners" },
                { id: "wasteBuyback", label: "Waste Buyback Program", type: "checkbox" },
                { id: "buybackIncomeRecipient", label: "Buyback Income Recipient", type: "text", dependsOn: "wasteBuyback", placeholder: "e.g., Client, Contractor" },
                { id: "wasteEquipmentList", label: "Waste Equipment on Site (Skips, Shredder, etc.)", type: "textarea", placeholder: "e.g., 2x 30yd skips, 1 compactor" },
                { id: "wasteEquipmentCondition", label: "Waste Equipment General Condition", type: "select", options: ["New", "Good", "Medium", "Poor"], required: false },
                { id: "wasteEquipmentMaintenanceResponsible", label: "Waste Equipment Maintenance Responsible", type: "text", placeholder: "e.g., Client, Contractor" },
                { id: "wasteRegisterResponsible", label: "Waste Register Responsible (Equans)", type: "checkbox" },
                { id: "hazardousWasteBSDsResponsible", label: "Hazardous Waste BSDs Responsible (Equans)", type: "checkbox" },
                { id: "otherTraceabilityRequirements", label: "Other Traceability/Declaration Requirements", type: "textarea", placeholder: "e.g., Annual environmental report" },
                { id: "wasteOrganization", label: "Waste Management Team Organization", type: "textarea", placeholder: "e.g., 1 Team Lead, 2 FTE" },
                { id: "wasteQualifications", label: "Required Qualifications (CACES, ADR, etc.)", type: "textarea", placeholder: "e.g., CACES permit for forklift" },
                { id: "workwearNeeded", label: "Workwear Needed", type: "checkbox" },
                { id: "workwearProvidedByClient", label: "Workwear Provided by Client", type: "checkbox", dependsOn: "workwearNeeded" }
            ],
            "Grounds Maintenance": [ // Renamed from "Grounds" for clarity
                { id: "areaAcres", label: "Area (Acres)", type: "number", required: true },
                { id: "servicesIncluded", label: "Services Included", type: "textarea", placeholder: "e.g., Mowing, Edging, Fertilization, Tree Care" },
                { id: "seasonalCare", label: "Seasonal Care Included", type: "checkbox" },
                { id: "accessLimitations", label: "Machine Access Limitations", type: "textarea", placeholder: "e.g., Narrow gates, steep slopes" },
                { id: "interventionHours", label: "Possible Intervention Days & Hours", type: "textarea", placeholder: "e.g., Mon-Fri, 7 AM - 5 PM" },
                { id: "equipmentOwnership", label: "Equipment Ownership", type: "text", placeholder: "e.g., Client, Contractor" },
                { id: "electricalEquipmentMandatory", label: "Electrical Equipment Mandatory", type: "checkbox" },
                { id: "automaticWatering", label: "Automatic Watering System", type: "checkbox" },
                { id: "storageAreas", label: "Suitable & Secure Storage Areas", type: "checkbox" },
                { id: "specificRisks", label: "Specific Risks (Slopes, Water, Height, etc.)", type: "textarea", placeholder: "e.g., Steep slopes, pond near work area" },
                { id: "siteSpecificities", label: "Site Specificities (Flood Zone, Extreme Cold, etc.)", type: "textarea", placeholder: "e.g., Flood zone near river, extremely cold winters" },
                { id: "travelTimeConsideration", label: "Travel Time Needs Consideration (Large Site)", type: "checkbox" },
                { id: "adaptedVehicleNeeded", label: "Adapted Vehicle Needed", type: "checkbox", dependsOn: "travelTimeConsideration" },
                { id: "adaptedVehicleProvidedByClient", label: "Adapted Vehicle Provided by Client", type: "checkbox", dependsOn: "adaptedVehicleNeeded" },
                { id: "sustainableDevelopmentPlan", label: "Sustainable Development Plan in Place", type: "checkbox" },
                { id: "pesticideDocument", label: "Pesticide Use Document Available", type: "checkbox" },
                { id: "pesticideRegister", label: "Pesticide Register Available", type: "checkbox" },
                { id: "greenWasteManagement", label: "Green Waste Management Method", type: "textarea", placeholder: "e.g., Composted on-site, off-site disposal" },
                { id: "healthTrailMaintenance", label: "Health Trail Maintenance Details", type: "textarea", placeholder: "e.g., Synthetic turf, client responsible" },
                { id: "organizationDescription", label: "Grounds Team Organization", type: "textarea", placeholder: "e.g., 1 supervisor, 3 FTE" }
            ],
            "Elevator Maintenance": [
                { id: "elevatorCount", label: "Elevator Count", type: "number", required: true },
                { id: "type", label: "Elevator Type", type: "select", options: ["Passenger", "Freight", "Hydraulic", "Traction", "Other"], required: true },
                { id: "lastInspectionDate", label: "Last Inspection Date", type: "date" },
                { id: "emergencyCallService", label: "24/7 Emergency Call Service", type: "checkbox" }
            ],
            "Building Fabric Maintenance": [
                { id: "exteriorMaterial", label: "Exterior Material", type: "text", placeholder: "e.g., Brick, Glass, Siding" },
                { id: "interiorFinishes", label: "Interior Finishes", type: "text", placeholder: "e.g., Drywall, Paint, Flooring" },
                { id: "inspectionFrequency", label: "Inspection Frequency", type: "select", options: ["Quarterly", "Bi-Annually", "Annually"], required: true },
                { id: "minorRepairsIncluded", label: "Minor Repairs Included", type: "checkbox" }
            ],

            // New Services
            "General Site Information": [
                { id: "clientTimeSpent", label: "Client Team Time Spent (Supervision/Admin)", type: "textarea", placeholder: "e.g., 20% of one FTE, 80 hours/month" },
                { id: "clientLaborMaterials", label: "Actual Client Labor & Materials Performing Tasks", type: "textarea", placeholder: "e.g., Client performs light bulb replacement with internal staff" },
                { id: "contractorLaborMaterials", label: "Actual Contractor Labor & Materials Performing Tasks", type: "textarea", placeholder: "e.g., Current contractor provides all materials for cleaning" },
                { id: "subcontractorTrainingRequirements", label: "Subcontractor Training & Escorting Requirements", type: "textarea", placeholder: "e.g., Mandatory safety training, escorted access to labs" },
                { id: "siteOrganizationChartSelfPerformed", label: "Org Chart for Self-Performed FM Services (Pay Rates)", type: "textarea", placeholder: "e.g., 1 FM Manager ($X/hr), 2 Technicians ($Y/hr)" },
                { id: "siteOrganizationChartSubcontracted", label: "Org Chart for Subcontracted FM Services (Employees/Hours)", type: "textarea", placeholder: "e.g., Janitorial: 5 FTE, 800 hrs/month" },
                { id: "unionContracts", label: "Union Contracts for Transferred Personnel", type: "textarea", placeholder: "e.g., Local 123 for maintenance staff" },
                { id: "siteOpeningHours", label: "Site Opening Hours & Breakdown (if closed)", type: "textarea", placeholder: "e.g., Mon-Fri 8 AM - 5 PM, closed holidays" },
                { id: "currentSLAs", label: "Any Current SLAs in Place", type: "textarea", placeholder: "e.g., HVAC uptime 98%, cleaning response time 24h" },
                { id: "kpisReportingSystems", label: "KPIs or Reporting Systems Used", type: "textarea", placeholder: "e.g., Monthly KPI dashboard, CMMS reports" },
                { id: "changeManagementSystem", label: "Change Management System Used", type: "text", placeholder: "e.g., ServiceNow, internal system" },
                { id: "internetAccess", label: "Internet Access Across Site", type: "checkbox" },
                { id: "clientProgramsInterface", label: "Client Programs Equans Will Interface With", type: "textarea", placeholder: "e.g., SAP, Maximo, internal ticketing system" },
                { id: "qualityProgramsUtilized", label: "Quality Programs Utilized by Client", type: "textarea", placeholder: "e.g., ISO 9001, 5S" },
                { id: "callCenterRequirements", label: "Any Call Center Requirements", type: "textarea", placeholder: "e.g., 24/7 support, multi-language" },
                { id: "changesImpactVolumes", label: "Changes Impacting Activity Volumes (Last Year)", type: "textarea", placeholder: "e.g., New production line added, 20% staff reduction" },
                { id: "personnelTransferMechanisms", label: "Conventional Personnel Transfer Mechanisms Apply (e.g., Bill 7)", type: "checkbox" },
                { id: "specificBonuses", label: "Specific Bonuses for Team (e.g., Security)", type: "textarea", placeholder: "e.g., Holiday bonus, performance bonus" },
                { id: "employeeQualifications", label: "Specific Employee Qualifications Required", type: "textarea", placeholder: "e.g., Security check, safety training, GMP" },
                { id: "clientExpectationsBestPractices", label: "Client Expectations: Best Practices with Current Contractor", type: "textarea", placeholder: "e.g., Proactive communication, quick issue resolution" },
                { id: "clientExpectationsImprovements", label: "Client Expectations: Improvements Needed", type: "textarea", placeholder: "e.g., Faster response times, better reporting" },
                { id: "itSystemsOnsite", label: "IT Systems Used On-site (Maintenance, Help Desk, Finance)", type: "textarea", placeholder: "e.g., Planned Maintenance: SAP, Help Desk: Jira, Finance: Oracle" },
                { id: "staffTakeoverPlan", label: "Plan to Take Over Staff", type: "checkbox" },
                { id: "vehicleNeededForDistances", label: "Vehicle Needed for Large Distances", type: "checkbox" },
                { id: "vehicleProvidedByClient", label: "Vehicle Provided by Client", type: "checkbox", dependsOn: "vehicleNeededForDistances" },
                { id: "generalTools", label: "General Tools Required", type: "textarea", placeholder: "e.g., Standard hand tools, multimeters, ladders" },
                { id: "comprehensivePPE", label: "Comprehensive PPE Requirements", type: "textarea", placeholder: "e.g., Safety boots, hard hats, safety glasses, gloves, specialized clothing for labs" },
                { id: "cmmsDataMigrationComplexity", label: "CMMS Data Migration Complexity", type: "textarea", placeholder: "e.g., High (complex data, many integrations), Medium, Low" }
            ],
            "Catering Services": [
                { id: "totalCashRevenueLastYear", label: "Total Cash Revenue Last Year (Local Currency)", type: "number" },
                { id: "breakfastsPerDay", label: "Total Breakfasts / Day", type: "number" },
                { id: "lunchesPerDay", label: "Total Lunches / Day", type: "number" },
                { id: "dinnersPerDay", label: "Total Dinners / Day", type: "number" },
                { id: "suppersPerDay", label: "Total Suppers (Night) / Day", type: "number" },
                { id: "hospitalityServicesLastYear", label: "Total Hospitality Services Provided Last Year", type: "number" },
                { id: "foodFacilitiesCount", label: "Number of Food Facilities On-site", type: "number" },
                { id: "foodFacilitiesType", label: "Type of Food Facilities", type: "textarea", placeholder: "e.g., Restaurant, Cafeteria, Kiosk" },
                { id: "foodFacilitiesOpeningHours", label: "Food Facilities Opening Hours per Outlet", type: "textarea", placeholder: "e.g., Cafeteria: 7 AM - 3 PM" },
                { id: "transportationImpact", label: "Impact of Distances/Transportation Time on Food Distribution", type: "select", options: ["Good", "Medium", "Bad"] },
                { id: "kitchenConditionImpact", label: "Impact of Kitchen/Building Condition on Food Production", type: "select", options: ["Good", "Medium", "Bad"] },
                { id: "foodStorageArea", label: "Food Storage Area Details", type: "textarea", placeholder: "e.g., Centralized, easy access, equipped" },
                { id: "foodBreakdownMenuTypes", label: "Average Breakdown of Food Sold / Menu Types / Diets", type: "textarea", placeholder: "e.g., 60% fresh, 40% semi-prepared; 3 menu choices, vegetarian options" },
                { id: "cateringOrganization", label: "Catering Team Organization", type: "textarea", placeholder: "e.g., 1 Service Supervisor, 5 FTE" }
            ],
            "Vending Services": [
                { id: "incumbentVendor", label: "Incumbent Vending Vendor", type: "text" },
                { id: "machineLocations", label: "Vending Machine Locations, Count, & Types", type: "textarea", placeholder: "e.g., Main lobby: 2 (drinks, snacks), 3rd floor: 1 (coffee)" },
                { id: "machineOwnership", label: "Vending Machine Ownership", type: "textarea", placeholder: "e.g., Drinks: Client, Snacks: Vendor" },
                { id: "officeCoffeeSolution", label: "Office Coffee Solution Available", type: "checkbox" },
                { id: "coffeeProvider", label: "Office Coffee Provider", type: "text", dependsOn: "officeCoffeeSolution" },
                { id: "numberOfBrewers", label: "Number of Coffee Brewers", type: "number", dependsOn: "officeCoffeeSolution" },
                { id: "typeOfBrewers", label: "Type of Coffee Brewers", type: "text", dependsOn: "officeCoffeeSolution", placeholder: "e.g., Single-serve, Drip" },
                { id: "coffeeProductsAvailable", label: "Coffee Products Available", type: "text", dependsOn: "officeCoffeeSolution", placeholder: "e.g., Coffee, Tea, Hot Chocolate" },
                { id: "coffeeDisposables", label: "Coffee Disposables Type", type: "text", dependsOn: "officeCoffeeSolution", placeholder: "e.g., Paper cups, stirrers" },
                { id: "waterFiltrationBottled", label: "Water Filtration or Bottled Water in Employee Area", type: "checkbox" },
                { id: "waterProvider", label: "Water Provider", type: "text", dependsOn: "waterFiltrationBottled" },
                { id: "waterMachineQuantity", label: "Quantity of Water Machines", type: "number", dependsOn: "waterFiltrationBottled" },
                { id: "waterConsumables", label: "Water Consumables Available", type: "text", dependsOn: "waterFiltrationBottled", placeholder: "e.g., Cups, bottles" },
                { id: "vendingCashRevenueLastYear", label: "Vending Cash Revenue Last Year (Overview)", type: "textarea", placeholder: "e.g., $5000/month average" },
                { id: "hotColdDrinksSnacksSold", label: "Number of Hot/Cold Drinks + Snacks Sold / Year", type: "number" },
                { id: "vendingLeasing", label: "Vending Machines are Leased", type: "checkbox" }
            ],
            "Indoor Plant Maintenance": [
                { id: "subcontracted", label: "Subcontracted or Self-Performed", type: "select", options: ["Subcontracted", "Self-Performed"] },
                { id: "contractAvailable", label: "Contract Available (if Subcontracted)", type: "checkbox", dependsOn: "subcontracted", dependsOnValue: ["Subcontracted"] },
                { id: "plantOwnership", label: "Plant & Container Ownership", type: "text", placeholder: "e.g., Client, Contractor" },
                { id: "maintenanceSchedules", label: "Maintenance Schedules for Indoor Plants", type: "textarea", placeholder: "e.g., Weekly, Bi-weekly" },
                { id: "plantTypesFrequency", label: "Types of Plants & Maintenance Frequency", type: "textarea", placeholder: "e.g., Pothos (weekly), Ficus (monthly)" },
                { id: "plantDescription", label: "Description of Indoor Plants", type: "textarea", placeholder: "e.g., Various sizes, mostly green foliage" },
                { id: "numberOfPlants", label: "Number of Indoor Plants", type: "number" }
            ],
            "FM Equipment Leasing": [
                { id: "equipmentList", label: "List of Equipment Leased", type: "textarea", placeholder: "e.g., Forklift truck, pallet trucks, photocopiers, floor cleaners" },
                { id: "leasingDuration", label: "Duration of Leasing (years/months)", type: "text", placeholder: "e.g., 3 years, 12 months" },
                { id: "maintenanceResponsible", label: "Responsible for Maintenance", type: "text", placeholder: "e.g., Lessor, Client, Equans" },
                { id: "maintenanceBudget", label: "Maintenance Budget (Annual)", type: "number" }
            ],
            "Fuel System Management": [
                { id: "gasList", label: "List of Gases to be Delivered", type: "textarea", placeholder: "e.g., Natural Gas, Propane, Diesel" },
                { id: "deliveryFrequencyVolumes", label: "Delivery Frequency & Volumes", type: "textarea", placeholder: "e.g., Natural Gas: Daily, 1000m3; Diesel: Monthly, 500L" },
                { id: "gasConsumption", label: "Gas Consumption (Annual)", type: "text", placeholder: "e.g., Natural Gas: 10,000 m3/year" }
            ],
            "Helpdesk Services": [
                { id: "helpdeskOrganization", label: "Helpdesk Team Organization", type: "textarea", placeholder: "e.g., 1 Supervisor, 3 Agents" },
                { id: "currentSystemProcedures", label: "Current System & Procedures Description", type: "textarea", placeholder: "e.g., Uses Zendesk for ticketing, email/phone support" },
                { id: "ticketsPerYear", label: "Number of Helpdesk Tickets / Year", type: "number" },
                { id: "hoursWorkingInHelpdesk", label: "Total Hours Worked in Helpdesk (Annual)", type: "number" },
                { id: "otherRelevantProcedures", label: "Other Relevant Helpdesk Procedures", type: "textarea", placeholder: "e.g., Escalation matrix, VIP support" }
            ],
            "Uniforms Management": [
                { id: "peopleWorkingOnUniforms", label: "Number of People Working on Uniforms & Time Spent", type: "textarea", placeholder: "e.g., 1 FTE (20% of time)" },
                { id: "personalUniformsCountSets", label: "Number of People with Personal Uniforms & Sets", type: "textarea", placeholder: "e.g., 50 employees, 3 sets each" },
                { id: "walkOffMatsCountSize", label: "Number & Size of Walk-off Mats", type: "textarea", placeholder: "e.g., 10 mats (3x5 ft)" },
                { id: "uniformsInventory", label: "Uniforms Inventory (Lab Coats, Shirts, Pants, etc.)", type: "textarea", placeholder: "e.g., 100 lab coats, 200 shirts, 200 pants" },
                { id: "uniformsQualityStandard", label: "Uniforms Quality Standard", type: "text", placeholder: "e.g., High durability, anti-static" },
                { id: "ppeQualityStandard", label: "PPE Quality Standard", type: "text", placeholder: "e.g., ANSI Z87.1 (eye protection)" }
            ],
            "Hard FM (General)": [
                { id: "criticalEnvironmentsEquipment", label: "Most Critical Environments/Equipment", type: "textarea", placeholder: "e.g., Server rooms, clean production lines, main electrical panels" },
                { id: "buildingListed", label: "Is the Building Listed (Historical/Protected)", type: "checkbox" },
                { id: "yearOfConstruction", label: "Year of Construction", type: "number" },
                { id: "lastMajorRefit", label: "Last Major Refit Year", type: "number" },
                { id: "constructionInfo", label: "General Construction Information (Frame, Roof, Floors, Walls)", type: "textarea", placeholder: "e.g., Steel frame, TPO roof (good condition), concrete floors, drywall walls" },
                { id: "assetsToBeMaintainedSummary", label: "Summary of Assets to be Maintained", type: "textarea", placeholder: "e.g., 50 HVAC units, 20 electrical panels, 5 elevators" },
                { id: "plantRoomsLargeAssets", label: "Number of Plant Rooms & Large Individual Assets", type: "textarea", placeholder: "e.g., 3 plant rooms (clean), 2 large chillers, 1 main generator" },
                { id: "partsStorageArea", label: "Parts Storage Area Details", type: "textarea", placeholder: "e.g., Centralized, accessible, equipped with shelves" },
                { id: "inProgressProjects", label: "Any In-Progress Projects Ongoing", type: "textarea", placeholder: "e.g., HVAC upgrade (50% complete), roof repair (starting next month)" },
                { id: "currentMaintenanceOrganization", label: "Current Maintenance Organization", type: "textarea", placeholder: "e.g., 1 Service Supervisor, 4 FTE Technicians, 2 shifts" },
                { id: "callOutProcess", label: "Call Out Process in Place", type: "checkbox" },
                { id: "standbyAllowance", label: "Standby Allowance for Staff", type: "checkbox", dependsOn: "callOutProcess" },
                { id: "staffOnCallWeekdays", label: "Number of Staff On Call (Weekdays)", type: "number", dependsOn: "callOutProcess" },
                { id: "staffOnCallWeekend", label: "Number of Staff On Call (Weekend)", type: "number", dependsOn: "callOutProcess" }
            ],
            "Scientific & Clinical Services": [
                { id: "equipmentList", label: "Detailed List of Scientific & Clinical Equipment", type: "textarea", placeholder: "e.g., Lab freezers, centrifuges, microscopes" }
            ]
        };

        // --- Utility Functions ---

        /**
         * Shows the loading spinner.
         */
        function showLoading() {
            loadingSpinner.classList.remove('hidden');
        }

        /**
         * Hides the loading spinner.
         */
        function hideLoading() {
            loadingSpinner.classList.add('hidden');
        }

        /**
         * Displays a custom message box.
         * @param {string} message - The message to display.
         */
        function showMessageBox(message) {
            messageBoxText.textContent = message;
            messageBox.classList.remove('hidden');
            messageBox.classList.add('flex');
        }

        /**
         * Hides the custom message box.
         */
        function hideMessageBox() {
            messageBox.classList.add('hidden');
            messageBox.classList.remove('flex');
        }

        /**
         * Displays a custom confirmation box.
         * @param {string} message - The confirmation message.
         * @returns {Promise<boolean>} - Resolves true if confirmed, false if cancelled.
         */
        function showConfirmationBox(message) {
            return new Promise(resolve => {
                confirmationBoxText.textContent = message;
                confirmationBox.classList.remove('hidden');
                confirmationBox.classList.add('flex');

                const confirmHandler = () => {
                    confirmationBox.classList.add('hidden');
                    confirmationBox.classList.remove('flex');
                    confirmationBoxConfirmBtn.removeEventListener('click', confirmHandler);
                    confirmationBoxCancelBtn.removeEventListener('click', cancelHandler);
                    resolve(true);
                };

                const cancelHandler = () => {
                    confirmationBox.classList.add('hidden');
                    confirmationBox.classList.remove('flex');
                    confirmationBoxConfirmBtn.removeEventListener('click', confirmHandler);
                    confirmationBoxCancelBtn.removeEventListener('click', cancelHandler);
                    resolve(false);
                };

                confirmationBoxConfirmBtn.addEventListener('click', confirmHandler);
                confirmationBoxCancelBtn.addEventListener('click', cancelHandler);
            });
        }

        /**
         * Displays a specific view and hides others.
         * @param {string} viewId - The ID of the view to display.
         */
        function showView(viewId) {
            const views = [projectsView, sitesView, zonesView, servicesView, serviceDetailView];
            views.forEach(view => {
                if (view.id === viewId) {
                    view.classList.remove('hidden');
                    view.classList.add('fade-in');
                } else {
                    view.classList.add('hidden');
                    view.classList.remove('fade-in');
                }
            });

            // Show/hide back button based on view
            if (viewId === 'projects-view') {
                backButton.classList.add('hidden');
            } else {
                backButton.classList.remove('hidden');
            }
            appState.currentView = viewId.replace('-view', ''); // Update app state
        }

        /**
         * Clears the content of a given list element.
         * @param {HTMLElement} listElement - The list element to clear.
         */
        function clearList(listElement) {
            listElement.innerHTML = '';
        }

        /**
         * Converts an image file to a Base64 string.
         * @param {File} file - The image file.
         * @returns {Promise<string>} - A promise that resolves with the Base64 string.
         */
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        }

        // --- Firebase Initialization and Auth ---

        /**
         * Initializes Firebase and handles user authentication.
         */
        async function initializeFirebase() {
            showLoading();
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        console.log("User authenticated:", userId);
                        isAuthReady = true;
                        await loadProjects(); // Load initial data once authenticated
                    } else {
                        // Sign in anonymously if no token is provided or user is not logged in
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                    hideLoading();
                });
            } catch (error) {
                console.error("Error initializing Firebase or authenticating:", error);
                showMessageBox("Failed to initialize the app. Please try again later.");
                hideLoading();
            }
        }

        // --- Project Management ---

        /**
         * Loads and displays projects for the current user.
         */
        async function loadProjects() {
            if (!isAuthReady) return;
            showLoading();
            clearList(projectsList);
            try {
                const q = query(collection(db, `artifacts/${appId}/users/${userId}/quotes`));
                onSnapshot(q, (snapshot) => {
                    clearList(projectsList); // Clear before re-rendering
                    if (snapshot.empty) {
                        projectsList.innerHTML = '<p class="text-gray-600 text-center py-8">No quotes found. Click "Add New Quote" to get started!</p>';
                    }
                    snapshot.forEach((doc) => {
                        const project = { id: doc.id, ...doc.data() };
                        const projectCard = `
                            <div class="bg-white p-6 rounded-lg shadow-md flex flex-col sm:flex-row justify-between items-start sm:items-center transition duration-300 ease-in-out transform hover:scale-[1.02]">
                                <div class="mb-4 sm:mb-0">
                                    <h3 class="text-xl font-semibold text-gray-800">${project.name}</h3>
                                    <p class="text-gray-600">Client: ${project.client}</p>
                                    <p class="text-gray-500 text-sm">Category: ${project.clientCategory || 'N/A'}</p>
                                    <p class="text-gray-500 text-sm">Subcategory: ${project.clientSubcategory || 'N/A'}</p>
                                    <p class="text-gray-500 text-sm">Created: ${new Date(project.date).toLocaleDateString()}</p>
                                    <p class="text-gray-500 text-sm">User ID: ${userId}</p>
                                </div>
                                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto">
                                    <button data-id="${project.id}" class="edit-project-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md shadow-sm">Edit</button>
                                    <button data-id="${project.id}" class="delete-project-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-sm">Delete</button>
                                    <button data-id="${project.id}" data-name="${project.name}" class="view-project-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-md shadow-sm">View</button>
                                </div>
                            </div>
                        `;
                        projectsList.insertAdjacentHTML('beforeend', projectCard);
                    });
                    attachProjectEventListeners();
                    hideLoading();
                    showView('projects-view');
                }, (error) => {
                    console.error("Error fetching projects:", error);
                    showMessageBox("Failed to load quotes.");
                    hideLoading();
                });
            } catch (error) {
                console.error("Error setting up project listener:", error);
                showMessageBox("Failed to load quotes.");
                hideLoading();
            }
        }

        /**
         * Attaches event listeners to project cards.
         */
        function attachProjectEventListeners() {
            document.querySelectorAll('.view-project-btn').forEach(button => {
                button.onclick = () => {
                    appState.currentProjectId = button.dataset.id;
                    appState.currentProjectName = button.dataset.name;
                    currentProjectNameSpan.textContent = appState.currentProjectName;
                    loadSites();
                };
            });
            document.querySelectorAll('.edit-project-btn').forEach(button => {
                button.onclick = async () => {
                    const projectId = button.dataset.id;
                    const projectDoc = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/quotes`, projectId));
                    if (projectDoc.exists()) {
                        const project = projectDoc.data();
                        appState.currentProjectId = projectId;
                        projectModalTitle.textContent = 'Edit Quote';
                        projectNameInput.value = project.name;
                        projectClientInput.value = project.client;
                        clientCategorySelect.value = project.clientCategory || '';
                        // Trigger subcategory population if a category is selected
                        if (project.clientCategory) {
                            populateSubcategories(project.clientCategory, project.clientSubcategory);
                        } else {
                            clientSubcategoryGroup.classList.add('hidden');
                            clientSubcategorySelect.innerHTML = '<option value="">Select Subcategory</option>';
                        }
                        projectModal.classList.remove('hidden');
                        projectModal.classList.add('flex');
                    } else {
                        showMessageBox("Quote not found for editing.");
                    }
                };
            });
            document.querySelectorAll('.delete-project-btn').forEach(button => {
                button.onclick = async () => {
                    const projectId = button.dataset.id;
                    const projectDoc = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/quotes`, projectId));
                    if (projectDoc.exists()) {
                        const projectName = projectDoc.data().name;
                        const confirmed = await showConfirmationBox(`Are you sure you want to delete the quote "${projectName}" and all its associated sites, zones, and services? This action cannot be undone.`);
                        if (confirmed) {
                            await deleteProject(projectId);
                        }
                    } else {
                        showMessageBox("Quote not found for deletion.");
                    }
                };
            });
        }

        /**
         * Handles adding/editing a project.
         * @param {Event} e - The form submission event.
         */
        async function handleProjectFormSubmit(e) {
            e.preventDefault();
            showLoading();
            const projectName = projectNameInput.value.trim();
            const projectClient = projectClientInput.value.trim();
            const clientCategory = clientCategorySelect.value;
            const clientSubcategory = clientSubcategorySelect.value;

            if (!projectName || !projectClient) {
                showMessageBox("Please fill in all required project fields.");
                hideLoading();
                return;
            }

            try {
                const projectData = {
                    name: projectName,
                    client: projectClient,
                    clientCategory: clientCategory,
                    clientSubcategory: clientSubcategory
                };

                if (appState.currentProjectId) { // Editing existing project
                    await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/quotes`, appState.currentProjectId), projectData);
                    showMessageBox("Quote updated successfully!");
                } else { // Adding new project
                    projectData.date = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/quotes`), projectData);
                    showMessageBox("New quote added successfully!");
                }
                projectModal.classList.add('hidden');
                projectModal.classList.remove('flex');
                projectForm.reset();
                appState.currentProjectId = null; // Reset for next add
            } catch (error) {
                console.error("Error saving project:", error);
                showMessageBox("Failed to save quote.");
            } finally {
                hideLoading();
            }
        }

        /**
         * Recursively deletes a document and all its subcollections.
         * Note: This is a simplified recursive delete. For very large collections,
         * it's better to use Firebase's Callable Cloud Functions or a dedicated backend process.
         * @param {string} path - The Firestore path to the document (e.g., `collection/docId`).
         */
        async function deleteDocumentAndSubcollections(path) {
            const docRef = doc(db, path);
            const collections = ['sites', 'zones', 'services']; // Define expected subcollections

            for (const subCollectionName of collections) {
                const subCollectionRef = collection(docRef, subCollectionName);
                const q = query(subCollectionRef);
                const snapshot = await getDocs(q);

                if (!snapshot.empty) {
                    const batch = writeBatch(db);
                    for (const subDoc of snapshot.docs) {
                        // Recursively delete sub-documents first
                        await deleteDocumentAndSubcollections(`${path}/${subCollectionName}/${subDoc.id}`);
                        batch.delete(subDoc.ref);
                    }
                    await batch.commit();
                }
            }
            // Finally, delete the document itself
            await deleteDoc(docRef);
        }

        /**
         * Deletes a project and all its associated data (sites, zones, services).
         * @param {string} projectId - The ID of the project to delete.
         */
        async function deleteProject(projectId) {
            showLoading();
            try {
                // Construct the full path to the project document
                const projectPath = `artifacts/${appId}/users/${userId}/quotes/${projectId}`;
                await deleteDocumentAndSubcollections(projectPath);

                showMessageBox("Quote and all associated data deleted successfully!");
                // Reset app state if the deleted project was the current one
                if (appState.currentProjectId === projectId) {
                    appState.currentProjectId = null;
                    appState.currentProjectName = null;
                    appState.currentSiteId = null;
                    appState.currentSiteName = null;
                    appState.currentSitePictures = [];
                    appState.currentSiteAssets = [];
                    appState.currentZoneId = null;
                    appState.currentZoneName = null;
                    appState.currentZonePictures = [];
                    appState.currentServiceId = null;
                    appState.currentServiceType = null;
                    appState.currentServiceData = {};
                    appState.currentServicePictures = [];
                }
                // loadProjects() will be triggered by onSnapshot listener
            } catch (error) {
                console.error("Error deleting project and its data:", error);
                showMessageBox("Failed to delete quote and its associated data.");
            } finally {
                hideLoading();
            }
        }


        // --- Site Management ---

        /**
         * Loads and displays sites for the current project.
         */
        async function loadSites() {
            if (!isAuthReady || !appState.currentProjectId) return;
            showLoading();
            clearList(sitesList);
            try {
                const q = query(collection(db, `artifacts/${appId}/users/${userId}/sites`), where("quoteId", "==", appState.currentProjectId));
                onSnapshot(q, (snapshot) => {
                    clearList(sitesList); // Clear before re-rendering
                    if (snapshot.empty) {
                        sitesList.innerHTML = '<p class="text-gray-600 text-center py-8">No sites found for this quote. Click "Add New Site" to add one.</p>';
                    }
                    snapshot.forEach((doc) => {
                        const site = { id: doc.id, ...doc.data() };
                        const thumbnailUrl = site.pictures && site.pictures.length > 0 ? site.pictures[0].url : 'https://placehold.co/60x60/cccccc/000000?text=No+Image';
                        const siteCard = `
                            <div class="bg-white p-6 rounded-lg shadow-md flex flex-col sm:flex-row justify-between items-start sm:items-center transition duration-300 ease-in-out transform hover:scale-[1.02]">
                                <div class="flex items-center mb-4 sm:mb-0">
                                    <img src="${thumbnailUrl}" alt="Site Thumbnail" class="w-16 h-16 object-cover rounded-md mr-4">
                                    <div>
                                        <h3 class="text-xl font-semibold text-gray-800">${site.name}</h3>
                                        <p class="text-gray-600">${site.address}</p>
                                        <p class="text-gray-500 text-sm">Sq Ft: ${site.totalSqFt}</p>
                                        <p class="text-gray-500 text-sm">Personnel: ${site.personnelShifts || 'N/A'}</p>
                                    </div>
                                </div>
                                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto">
                                    <button data-id="${site.id}" class="edit-site-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md shadow-sm">Edit</button>
                                    <button data-id="${site.id}" class="delete-site-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-sm">Delete</button>
                                    <button data-id="${site.id}" data-name="${site.name}" class="view-site-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-md shadow-sm">View</button>
                                </div>
                            </div>
                        `;
                        sitesList.insertAdjacentHTML('beforeend', siteCard);
                    });
                    attachSiteEventListeners();
                    hideLoading();
                    showView('sites-view');
                }, (error) => {
                    console.error("Error fetching sites:", error);
                    showMessageBox("Failed to load sites.");
                    hideLoading();
                });
            } catch (error) {
                console.error("Error setting up site listener:", error);
                showMessageBox("Failed to load sites.");
                hideLoading();
            }
        }

        /**
         * Attaches event listeners to site cards.
         */
        function attachSiteEventListeners() {
            document.querySelectorAll('.view-site-btn').forEach(button => {
                button.onclick = () => {
                    appState.currentSiteId = button.dataset.id;
                    appState.currentSiteName = button.dataset.name;
                    currentSiteNameSpan.textContent = appState.currentSiteName;
                    loadZones();
                };
            });
            document.querySelectorAll('.edit-site-btn').forEach(button => {
                button.onclick = async () => {
                    const siteId = button.dataset.id;
                    const siteDoc = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/sites`, siteId));
                    if (siteDoc.exists()) {
                        const site = siteDoc.data();
                        appState.currentSiteId = siteId;
                        appState.currentSitePictures = site.pictures || []; // Load existing pictures
                        appState.currentSiteAssets = site.assets || []; // Load existing assets

                        siteModalTitle.textContent = 'Edit Site';
                        siteNameInput.value = site.name;
                        siteAddressInput.value = site.address;
                        siteTotalSqFtInput.value = site.totalSqFt;
                        sitePersonnelShiftsInput.value = site.personnelShifts || '';

                        // Load maintenance strategy fields
                        ppmRmSplitCurrentInput.value = site.ppmRmSplitCurrent || '';
                        ppmRmSplitProposedInput.value = site.ppmRmSplitProposed || '';
                        detailedSLAsInput.value = site.detailedSLAs || '';
                        clientPriorityPainPointsInput.value = site.clientPriorityPainPoints || '';
                        complianceRequirementsInput.value = site.complianceRequirements || '';

                        renderSitePicturesInModal();
                        renderAssetsInSiteModal(); // Render assets in modal
                        siteModal.classList.remove('hidden');
                        siteModal.classList.add('flex');
                    } else {
                        showMessageBox("Site not found for editing.");
                    }
                };
            });
            document.querySelectorAll('.delete-site-btn').forEach(button => {
                button.onclick = async () => {
                    const siteId = button.dataset.id;
                    const siteDoc = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/sites`, siteId));
                    if (siteDoc.exists()) {
                        const siteName = siteDoc.data().name;
                        const confirmed = await showConfirmationBox(`Are you sure you want to delete the site "${siteName}" and all its associated zones and services? This action cannot be undone.`);
                        if (confirmed) {
                            await deleteSite(siteId);
                        }
                    } else {
                        showMessageBox("Site not found for deletion.");
                    }
                };
            });
        }

        /**
         * Renders the images associated with the current site in the modal.
         */
        function renderSitePicturesInModal() {
            siteImagesPreview.innerHTML = '';
            if (appState.currentSitePictures.length === 0) {
                siteImagesPreview.innerHTML = '<p class="text-gray-600 col-span-full text-center">No images added yet.</p>';
            }
            appState.currentSitePictures.forEach((pic, index) => {
                const imgContainer = document.createElement('div');
                imgContainer.classList.add('relative', 'group', 'rounded-lg', 'overflow-hidden', 'shadow-md');
                imgContainer.innerHTML = `
                    <img src="${pic.url}" alt="Site Image ${index + 1}" class="w-full h-32 object-cover rounded-lg">
                    <button data-index="${index}" class="delete-site-image-btn absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm2 3a1 1 0 011-1h2a1 1 0 110 2h-2a1 1 0 01-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <p class="text-xs text-gray-700 p-2">${pic.description || 'No description'}</p>
                `;
                siteImagesPreview.appendChild(imgContainer);
            });

            document.querySelectorAll('.delete-site-image-btn').forEach(button => {
                button.onclick = async (event) => {
                    const indexToDelete = parseInt(event.currentTarget.dataset.index);
                    const confirmed = await showConfirmationBox("Are you sure you want to delete this image?");
                    if (confirmed) {
                        deleteSiteImage(indexToDelete);
                    }
                };
            });
        }

        /**
         * Handles image input change for sites, converts to Base64, and adds to site pictures.
         * @param {Event} e - The change event from the file input.
         */
        async function handleSiteImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                showLoading();
                try {
                    const base64Image = await fileToBase64(file);
                    const description = prompt("Enter a brief description for this image (optional):");
                    appState.currentSitePictures.push({ url: base64Image, description: description || '' });
                    renderSitePicturesInModal();
                } catch (error) {
                    console.error("Error processing site image:", error);
                    showMessageBox("Failed to add site image.");
                } finally {
                    hideLoading();
                    e.target.value = ''; // Clear input to allow re-uploading same file
                }
            }
        }

        /**
         * Deletes an image from the current site's pictures array.
         * @param {number} index - The index of the image to delete.
         */
        async function deleteSiteImage(index) {
            showLoading();
            try {
                appState.currentSitePictures.splice(index, 1);
                renderSitePicturesInModal();
            } catch (error) {
                console.error("Error deleting site image:", error);
                showMessageBox("Failed to delete site image.");
            } finally {
                hideLoading();
            }
        }

        /**
         * Handles adding/editing a site.
         * @param {Event} e - The form submission event.
         */
        async function handleSiteFormSubmit(e) {
            e.preventDefault();
            showLoading();
            const siteName = siteNameInput.value.trim();
            const siteAddress = siteAddressInput.value.trim();
            const siteTotalSqFt = parseFloat(siteTotalSqFtInput.value);
            const sitePersonnelShifts = sitePersonnelShiftsInput.value.trim();

            // New maintenance strategy fields
            const ppmRmSplitCurrent = ppmRmSplitCurrentInput.value.trim();
            const ppmRmSplitProposed = ppmRmSplitProposedInput.value.trim();
            const detailedSLAs = detailedSLAsInput.value.trim();
            const clientPriorityPainPoints = clientPriorityPainPointsInput.value.trim();
            const complianceRequirements = complianceRequirementsInput.value.trim();


            if (!siteName || !siteAddress || isNaN(siteTotalSqFt)) {
                showMessageBox("Please fill in all required site fields.");
                hideLoading();
                return;
            }

            try {
                const siteData = {
                    quoteId: appState.currentProjectId,
                    name: siteName,
                    address: siteAddress,
                    totalSqFt: siteTotalSqFt,
                    personnelShifts: sitePersonnelShifts,
                    pictures: appState.currentSitePictures,
                    assets: appState.currentSiteAssets, // Save site assets
                    // Save maintenance strategy fields
                    ppmRmSplitCurrent: ppmRmSplitCurrent,
                    ppmRmSplitProposed: ppmRmSplitProposed,
                    detailedSLAs: detailedSLAs,
                    clientPriorityPainPoints: clientPriorityPainPoints,
                    complianceRequirements: complianceRequirements
                };

                if (appState.currentSiteId) { // Editing existing site
                    await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/sites`, appState.currentSiteId), siteData);
                    showMessageBox("Site updated successfully!");
                } else { // Adding new site
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/sites`), siteData);
                    showMessageBox("New site added successfully!");
                }
                siteModal.classList.add('hidden');
                siteModal.classList.remove('flex');
                siteForm.reset();
                appState.currentSiteId = null; // Reset for next add
                appState.currentSitePictures = []; // Clear pictures after saving
                appState.currentSiteAssets = []; // Clear assets after saving
            } catch (error) {
                console.error("Error saving site:", error);
                showMessageBox("Failed to save site.");
            } finally {
                hideLoading();
            }
        }

        /**
         * Deletes a site and all its associated data (zones, services).
         * @param {string} siteId - The ID of the site to delete.
         */
        async function deleteSite(siteId) {
            showLoading();
            try {
                const sitePath = `artifacts/${appId}/users/${userId}/sites/${siteId}`;
                await deleteDocumentAndSubcollections(sitePath);

                showMessageBox("Site and all associated data deleted successfully!");
                // Reset app state if the deleted site was the current one
                if (appState.currentSiteId === siteId) {
                    appState.currentSiteId = null;
                    appState.currentSiteName = null;
                    appState.currentSitePictures = [];
                    appState.currentSiteAssets = [];
                    appState.currentZoneId = null;
                    appState.currentZoneName = null;
                    appState.currentZonePictures = [];
                    appState.currentServiceId = null;
                    appState.currentServiceType = null;
                    appState.currentServiceData = {};
                    appState.currentServicePictures = [];
                }
                // loadSites() will be triggered by onSnapshot listener
            } catch (error) {
                console.error("Error deleting site and its data:", error);
                showMessageBox("Failed to delete site and its associated data.");
            } finally {
                hideLoading();
            }
        }

        // --- Zone Management ---

        /**
         * Loads and displays zones for the current site.
         */
        async function loadZones() {
            if (!isAuthReady || !appState.currentSiteId) return;
            showLoading();
            clearList(zonesList);
            try {
                const q = query(collection(db, `artifacts/${appId}/users/${userId}/zones`), where("siteId", "==", appState.currentSiteId));
                onSnapshot(q, (snapshot) => {
                    clearList(zonesList); // Clear before re-rendering
                    if (snapshot.empty) {
                        zonesList.innerHTML = '<p class="text-gray-600 text-center py-8">No zones found for this site. Click "Add New Zone" to add one.</p>';
                    }
                    snapshot.forEach((doc) => {
                        const zone = { id: doc.id, ...doc.data() };
                        const thumbnailUrl = zone.pictures && zone.pictures.length > 0 ? zone.pictures[0].url : 'https://placehold.co/60x60/cccccc/000000?text=No+Image';
                        const zoneCard = `
                            <div class="bg-white p-6 rounded-lg shadow-md flex flex-col sm:flex-row justify-between items-start sm:items-center transition duration-300 ease-in-out transform hover:scale-[1.02]">
                                <div class="flex items-center mb-4 sm:mb-0">
                                    <img src="${thumbnailUrl}" alt="Zone Thumbnail" class="w-16 h-16 object-cover rounded-md mr-4">
                                    <div>
                                        <h3 class="text-xl font-semibold text-gray-800">${zone.name}</h3>
                                        <p class="text-gray-600">Function: ${zone.zoneFunction || 'N/A'}</p>
                                        <p class="text-gray-500 text-sm">Sq Ft: ${zone.sqFt}</p>
                                    </div>
                                </div>
                                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 w-full sm:w-auto">
                                    <button data-id="${zone.id}" class="edit-zone-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-md shadow-sm">Edit</button>
                                    <button data-id="${zone.id}" class="delete-zone-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-md shadow-sm">Delete</button>
                                    <button data-id="${zone.id}" data-name="${zone.name}" class="view-zone-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-md shadow-sm">View</button>
                                </div>
                            </div>
                        `;
                        zonesList.insertAdjacentHTML('beforeend', zoneCard);
                    });
                    attachZoneEventListeners();
                    hideLoading();
                    showView('zones-view');
                }, (error) => {
                    console.error("Error fetching zones:", error);
                    showMessageBox("Failed to load zones.");
                    hideLoading();
                });
            } catch (error) {
                console.error("Error setting up zone listener:", error);
                showMessageBox("Failed to load zones.");
                hideLoading();
            }
        }

        /**
         * Attaches event listeners to zone cards.
         */
        function attachZoneEventListeners() {
            document.querySelectorAll('.view-zone-btn').forEach(button => {
                button.onclick = () => {
                    appState.currentZoneId = button.dataset.id;
                    appState.currentZoneName = button.dataset.name;
                    currentZoneNameSpan.textContent = appState.currentZoneName;
                    loadServices();
                };
            });
            document.querySelectorAll('.edit-zone-btn').forEach(button => {
                button.onclick = async () => {
                    const zoneId = button.dataset.id;
                    const zoneDoc = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/zones`, zoneId));
                    if (zoneDoc.exists()) {
                        const zone = zoneDoc.data();
                        appState.currentZoneId = zoneId;
                        appState.currentZonePictures = zone.pictures || []; // Load existing pictures
                        zoneModalTitle.textContent = 'Edit Zone';
                        zoneNameInput.value = zone.name;
                        zoneSqFtInput.value = zone.sqFt;
                        zoneFunctionSelect.value = zone.zoneFunction || '';
                        renderZonePicturesInModal(); // Render pictures in modal
                        zoneModal.classList.remove('hidden');
                        zoneModal.classList.add('flex');
                    } else {
                        showMessageBox("Zone not found for editing.");
                    }
                };
            });
            document.querySelectorAll('.delete-zone-btn').forEach(button => {
                button.onclick = async () => {
                    const zoneId = button.dataset.id;
                    const zoneDoc = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/zones`, zoneId));
                    if (zoneDoc.exists()) {
                        const zoneName = zoneDoc.data().name;
                        const confirmed = await showConfirmationBox(`Are you sure you want to delete the zone "${zoneName}" and all its associated services? This action cannot be undone.`);
                        if (confirmed) {
                            await deleteZone(zoneId);
                        }
                    } else {
                        showMessageBox("Zone not found for deletion.");
                    }
                };
            });
        }

        /**
         * Renders the images associated with the current zone in the modal.
         */
        function renderZonePicturesInModal() {
            zoneImagesPreview.innerHTML = '';
            if (appState.currentZonePictures.length === 0) {
                zoneImagesPreview.innerHTML = '<p class="text-gray-600 col-span-full text-center">No images added yet.</p>';
            }
            appState.currentZonePictures.forEach((pic, index) => {
                const imgContainer = document.createElement('div');
                imgContainer.classList.add('relative', 'group', 'rounded-lg', 'overflow-hidden', 'shadow-md');
                imgContainer.innerHTML = `
                    <img src="${pic.url}" alt="Zone Image ${index + 1}" class="w-full h-32 object-cover rounded-lg">
                    <button data-index="${index}" class="delete-zone-image-btn absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm2 3a1 1 0 011-1h2a1 1 0 110 2h-2a1 1 0 01-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <p class="text-xs text-gray-700 p-2">${pic.description || 'No description'}</p>
                `;
                zoneImagesPreview.appendChild(imgContainer);
            });

            document.querySelectorAll('.delete-zone-image-btn').forEach(button => {
                button.onclick = async (event) => {
                    const indexToDelete = parseInt(event.currentTarget.dataset.index);
                    const confirmed = await showConfirmationBox("Are you sure you want to delete this image?");
                    if (confirmed) {
                        deleteZoneImage(indexToDelete);
                    }
                };
            });
        }

        /**
         * Handles image input change for zones, converts to Base64, and adds to zone pictures.
         * @param {Event} e - The change event from the file input.
         */
        async function handleZoneImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                showLoading();
                try {
                    const base64Image = await fileToBase64(file);
                    const description = prompt("Enter a brief description for this image (optional):");
                    appState.currentZonePictures.push({ url: base64Image, description: description || '' });
                    renderZonePicturesInModal();
                } catch (error) {
                    console.error("Error processing zone image:", error);
                    showMessageBox("Failed to add zone image.");
                } finally {
                    hideLoading();
                    e.target.value = ''; // Clear input to allow re-uploading same file
                }
            }
        }

        /**
         * Deletes an image from the current zone's pictures array.
         * @param {number} index - The index of the image to delete.
         */
        async function deleteZoneImage(index) {
            showLoading();
            try {
                appState.currentZonePictures.splice(index, 1);
                renderZonePicturesInModal();
            } catch (error) {
                console.error("Error deleting zone image:", error);
                showMessageBox("Failed to delete zone image.");
            } finally {
                hideLoading();
            }
        }

        /**
         * Handles adding/editing a zone.
         * @param {Event} e - The form submission event.
         */
        async function handleZoneFormSubmit(e) {
            e.preventDefault();
            showLoading();
            const zoneName = zoneNameInput.value.trim();
            const zoneSqFt = parseFloat(zoneSqFtInput.value);
            const zoneFunction = zoneFunctionSelect.value;

            if (!zoneName || isNaN(zoneSqFt)) {
                showMessageBox("Please fill in all required zone fields.");
                hideLoading();
                return;
            }

            try {
                const zoneData = {
                    siteId: appState.currentSiteId,
                    name: zoneName,
                    sqFt: zoneSqFt,
                    zoneFunction: zoneFunction,
                    pictures: appState.currentZonePictures // Save zone pictures
                };

                if (appState.currentZoneId) { // Editing existing zone
                    await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/zones`, appState.currentZoneId), zoneData);
                    showMessageBox("Zone updated successfully!");
                } else { // Adding new zone
                    await addDoc(collection(db, `artifacts/${appId}/users/${userId}/zones`), zoneData);
                    showMessageBox("New zone added successfully!");
                }
                zoneModal.classList.add('hidden');
                zoneModal.classList.remove('flex');
                zoneForm.reset();
                appState.currentZoneId = null; // Reset for next add
                appState.currentZonePictures = []; // Clear pictures after saving
            } catch (error) {
                console.error("Error saving zone:", error);
                showMessageBox("Failed to save zone.");
            } finally {
                hideLoading();
            }
        }

        /**
         * Deletes a zone and all its associated data (services).
         * @param {string} zoneId - The ID of the zone to delete.
         */
        async function deleteZone(zoneId) {
            showLoading();
            try {
                const zonePath = `artifacts/${appId}/users/${userId}/zones/${zoneId}`;
                await deleteDocumentAndSubcollections(zonePath);

                showMessageBox("Zone and all associated data deleted successfully!");
                // Reset app state if the deleted zone was the current one
                if (appState.currentZoneId === zoneId) {
                    appState.currentZoneId = null;
                    appState.currentZoneName = null;
                    appState.currentZonePictures = [];
                    appState.currentServiceId = null;
                    appState.currentServiceType = null;
                    appState.currentServiceData = {};
                    appState.currentServicePictures = [];
                }
                // loadZones() will be triggered by onSnapshot listener
            } catch (error) {
                console.error("Error deleting zone and its data:", error);
                showMessageBox("Failed to delete zone and its associated data.");
            } finally {
                hideLoading();
            }
        }

        // --- Service Management ---

        /**
         * Loads and displays services for the current zone.
         */
        async function loadServices() {
            if (!isAuthReady || !appState.currentZoneId) return;
            showLoading();
            clearList(servicesList);
            try {
                const q = query(collection(db, `artifacts/${appId}/users/${userId}/services`), where("zoneId", "==", appState.currentZoneId));
                onSnapshot(q, (snapshot) => {
                    clearList(servicesList); // Clear before re-rendering
                    if (snapshot.empty) {
                        servicesList.innerHTML = '<p class="text-gray-600 text-center py-8">No services found for this zone. Click "Add New Service" to add one.</p>';
                    }
                    snapshot.forEach((doc) => {
                        const service = { id: doc.id, ...doc.data() };
                        const serviceCard = `
                            <div class="bg-white p-6 rounded-lg shadow-md flex justify-between items-center transition duration-300 ease-in-out transform hover:scale-[1.02]">
                                <div>
                                    <h3 class="text-xl font-semibold text-gray-800">${service.serviceType}</h3>
                                    <p class="text-gray-600">Details: ${Object.keys(service.data || {}).length > 0 ? Object.keys(service.data).map(key => `${key}: ${service.data[key]}`).join(', ').substring(0, 100) + '...' : 'N/A'}</p>
                                    ${service.note ? `<p class="text-gray-500 text-sm">Note: ${service.note.substring(0, 50)}...</p>` : ''}
                                </div>
                                <button data-id="${service.id}" data-type="${service.serviceType}" class="view-service-btn bg-orange-500 hover:bg-orange-600 text-white font-bold py-2 px-4 rounded-md shadow-sm">View</button>
                            </div>
                        `;
                        servicesList.insertAdjacentHTML('beforeend', serviceCard);
                    });
                    attachServiceEventListeners();
                    hideLoading();
                    showView('services-view');
                }, (error) => {
                    console.error("Error fetching services:", error);
                    showMessageBox("Failed to load services.");
                    hideLoading();
                });
            } catch (error) {
                console.error("Error setting up service listener:", error);
                showMessageBox("Failed to load services.");
                hideLoading();
            }
        }

        /**
         * Attaches event listeners to service cards.
         */
        function attachServiceEventListeners() {
            document.querySelectorAll('.view-service-btn').forEach(button => {
                button.onclick = async () => {
                    appState.currentServiceId = button.dataset.id;
                    appState.currentServiceType = button.dataset.type;
                    currentServiceTypeNameSpan.textContent = appState.currentServiceType;
                    await loadServiceDetails(appState.currentServiceId);
                };
            });
        }

        /**
         * Populates the service type dropdown in the service modal.
         */
        function populateServiceTypeDropdown() {
            serviceTypeSelect.innerHTML = '<option value="">Select a service type</option>';
            Object.keys(SERVICE_DEFINITIONS).sort().forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                serviceTypeSelect.appendChild(option);
            });
        }

        /**
         * Handles adding a new service.
         * @param {Event} e - The form submission event.
         */
        async function handleServiceFormSubmit(e) {
            e.preventDefault();
            showLoading();
            const serviceType = serviceTypeSelect.value;

            if (!serviceType) {
                showMessageBox("Please select a service type.");
                hideLoading();
                return;
            }

            try {
                const newServiceRef = await addDoc(collection(db, `artifacts/${appId}/users/${userId}/services`), {
                    zoneId: appState.currentZoneId,
                    serviceType: serviceType,
                    data: {}, // Initialize with empty data
                    pictures: [], // Initialize with empty pictures
                    note: '' // Initialize with empty note
                });
                showMessageBox(`New ${serviceType} service added!`);
                serviceModal.classList.add('hidden');
                serviceModal.classList.remove('flex');
                serviceForm.reset();

                // Immediately navigate to the detail view of the newly created service
                appState.currentServiceId = newServiceRef.id;
                appState.currentServiceType = serviceType;
                currentServiceTypeNameSpan.textContent = appState.currentServiceType;
                await loadServiceDetails(newServiceRef.id);

            } catch (error) {
                console.error("Error adding service:", error);
                showMessageBox("Failed to add service.");
            } finally {
                hideLoading();
            }
        }

        /**
         * Loads and displays details for a specific service.
         * @param {string} serviceId - The ID of the service to load.
         */
        async function loadServiceDetails(serviceId) {
            if (!isAuthReady || !serviceId) return;
            showLoading();
            try {
                const serviceDoc = await getDoc(doc(db, `artifacts/${appId}/users/${userId}/services`, serviceId));
                if (serviceDoc.exists()) {
                    const serviceData = serviceDoc.data();
                    appState.currentServiceType = serviceData.serviceType;
                    appState.currentServiceData = serviceData.data || {};
                    appState.currentServicePictures = serviceData.pictures || [];
                    serviceNoteInput.value = serviceData.note || ''; // Load the note

                    currentServiceTypeNameSpan.textContent = appState.currentServiceType;
                    renderDynamicServiceFields();
                    renderServicePictures();
                    showView('service-detail-view');
                } else {
                    showMessageBox("Service not found.");
                    showView('services-view'); // Go back to services list
                }
            } catch (error) {
                console.error("Error loading service details:", error);
                showMessageBox("Failed to load service details.");
            } finally {
                hideLoading();
            }
        }

        /**
         * Renders dynamic input fields based on the selected service type.
         */
        function renderDynamicServiceFields() {
            dynamicServiceFields.innerHTML = '';
            const serviceFields = SERVICE_DEFINITIONS[appState.currentServiceType];

            if (!serviceFields) {
                dynamicServiceFields.innerHTML = '<p class="text-gray-600">No specific fields defined for this service type.</p>';
                return;
            }

            serviceFields.forEach(field => {
                const fieldGroup = document.createElement('div');
                fieldGroup.classList.add('mb-4');

                const label = document.createElement('label');
                label.htmlFor = field.id;
                label.classList.add('block', 'text-gray-700', 'font-semibold', 'mb-2');
                label.textContent = field.label + (field.required ? ' *' : '');
                fieldGroup.appendChild(label);

                let inputElement;
                if (field.type === 'select') {
                    inputElement = document.createElement('select');
                    inputElement.classList.add('w-full', 'p-3', 'border', 'border-gray-300', 'rounded-md', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-500');
                    inputElement.id = field.id;
                    if (field.required) inputElement.required = true;
                    field.options.forEach(optionText => {
                        const option = document.createElement('option');
                        option.value = optionText;
                        option.textContent = optionText;
                        inputElement.appendChild(option);
                    });
                } else if (field.type === 'textarea') {
                    inputElement = document.createElement('textarea');
                    inputElement.classList.add('w-full', 'p-3', 'border', 'border-gray-300', 'rounded-md', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-500');
                    inputElement.id = field.id;
                    inputElement.rows = 3;
                    if (field.required) inputElement.required = true;
                    if (field.placeholder) inputElement.placeholder = field.placeholder;
                } else if (field.type === 'checkbox') {
                    inputElement = document.createElement('input');
                    inputElement.type = 'checkbox';
                    inputElement.id = field.id;
                    inputElement.classList.add('mr-2', 'h-5', 'w-5', 'text-blue-600', 'rounded', 'focus:ring-blue-500');
                    // Wrap checkbox in a flex container for better alignment
                    const checkboxWrapper = document.createElement('div');
                    checkboxWrapper.classList.add('flex', 'items-center');
                    checkboxWrapper.appendChild(inputElement);
                    checkboxWrapper.appendChild(label); // Move label next to checkbox
                    fieldGroup.innerHTML = ''; // Clear original label
                    fieldGroup.appendChild(checkboxWrapper);
                } else {
                    inputElement = document.createElement('input');
                    inputElement.type = field.type;
                    inputElement.id = field.id;
                    inputElement.classList.add('w-full', 'p-3', 'border', 'border-gray-300', 'rounded-md', 'focus:outline-none', 'focus:ring-2', 'focus:ring-blue-500');
                    if (field.required) inputElement.required = true;
                    if (field.placeholder) inputElement.placeholder = field.placeholder;
                }

                // Set initial value from appState.currentServiceData
                if (field.type === 'checkbox') {
                    inputElement.checked = appState.currentServiceData[field.id] || false;
                } else {
                    inputElement.value = appState.currentServiceData[field.id] || '';
                }

                // Handle dependencies for fields
                if (field.dependsOn) {
                    fieldGroup.classList.add('hidden'); // Hide by default
                    const parentField = serviceFields.find(f => f.id === field.dependsOn);
                    if (parentField) {
                        const parentInput = dynamicServiceFields.querySelector(`#${parentField.id}`);
                        if (parentInput) {
                            const updateVisibility = () => {
                                let show = false;
                                if (parentField.type === 'checkbox') {
                                    show = parentInput.checked;
                                } else if (parentField.type === 'select') {
                                    show = field.dependsOnValue.includes(parentInput.value);
                                }
                                if (show) {
                                    fieldGroup.classList.remove('hidden');
                                } else {
                                    fieldGroup.classList.add('hidden');
                                    // Clear value if hidden
                                    if (field.type === 'checkbox') {
                                        inputElement.checked = false;
                                    } else {
                                        inputElement.value = '';
                                    }
                                }
                            };
                            parentInput.addEventListener('change', updateVisibility);
                            // Initial check
                            updateVisibility();
                        }
                    }
                }

                if (field.type !== 'checkbox') { // Checkbox label already handled
                    fieldGroup.appendChild(inputElement);
                }
                dynamicServiceFields.appendChild(fieldGroup);
            });
        }

        /**
         * Renders the images associated with the current service.
         */
        function renderServicePictures() {
            serviceImagesPreview.innerHTML = '';
            if (appState.currentServicePictures.length === 0) {
                serviceImagesPreview.innerHTML = '<p class="text-gray-600 col-span-full text-center">No images added yet.</p>';
            }
            appState.currentServicePictures.forEach((pic, index) => {
                const imgContainer = document.createElement('div');
                imgContainer.classList.add('relative', 'group', 'rounded-lg', 'overflow-hidden', 'shadow-md');
                imgContainer.innerHTML = `
                    <img src="${pic.url}" alt="Service Image ${index + 1}" class="w-full h-32 object-cover rounded-lg">
                    <button data-index="${index}" class="delete-image-btn absolute top-2 right-2 bg-red-500 hover:bg-red-600 text-white p-1 rounded-full opacity-0 group-hover:opacity-100 transition-opacity duration-300">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 011-1h4a1 1 0 110 2H8a1 1 0 01-1-1zm2 3a1 1 0 011-1h2a1 1 0 110 2h-2a1 1 0 01-1-1z" clip-rule="evenodd" />
                        </svg>
                    </button>
                    <p class="text-xs text-gray-700 p-2">${pic.description || 'No description'}</p>
                `;
                serviceImagesPreview.appendChild(imgContainer);
            });

            document.querySelectorAll('.delete-image-btn').forEach(button => {
                button.onclick = async (event) => {
                    const indexToDelete = parseInt(event.currentTarget.dataset.index);
                    const confirmed = await showConfirmationBox("Are you sure you want to delete this image?");
                    if (confirmed) {
                        deleteServiceImage(indexToDelete);
                    }
                };
            });
        }

        /**
         * Handles image input change, converts to Base64, and adds to service pictures.
         * @param {Event} e - The change event from the file input.
         */
        async function handleServiceImageUpload(e) {
            const file = e.target.files[0];
            if (file) {
                showLoading();
                try {
                    const base64Image = await fileToBase64(file);
                    // Prompt user for description (optional)
                    const description = prompt("Enter a brief description for this image (optional):");

                    appState.currentServicePictures.push({
                        url: base64Image,
                        description: description || ''
                    });
                    renderServicePictures();
                    // Save immediately after adding image
                    await saveServiceDetails();
                    showMessageBox("Image added and service saved!");
                } catch (error) {
                    console.error("Error processing image:", error);
                    showMessageBox("Failed to add image.");
                } finally {
                    hideLoading();
                    e.target.value = ''; // Clear input to allow re-uploading same file
                }
            }
        }

        /**
         * Deletes an image from the current service's pictures array.
         * @param {number} index - The index of the image to delete.
         */
        async function deleteServiceImage(index) {
            showLoading();
            try {
                appState.currentServicePictures.splice(index, 1);
                renderServicePictures();
                await saveServiceDetails(); // Save changes to Firestore
                showMessageBox("Image deleted successfully!");
            } catch (error) {
                console.error("Error deleting image:", error);
                showMessageBox("Failed to delete image.");
            } finally {
                hideLoading();
            }
        }

        /**
         * Saves the current service details (dynamic fields and pictures) to Firestore.
         */
        async function saveServiceDetails() {
            if (!isAuthReady || !appState.currentServiceId) return;

            const serviceDataToSave = {};
            const serviceFields = SERVICE_DEFINITIONS[appState.currentServiceType];

            if (serviceFields) {
                serviceFields.forEach(field => {
                    const input = dynamicServiceFields.querySelector(`#${field.id}`);
                    if (input) {
                        if (field.type === 'checkbox') {
                            serviceDataToSave[field.id] = input.checked;
                        } else if (field.type === 'number') {
                            serviceDataToSave[field.id] = parseFloat(input.value) || 0;
                        } else {
                            serviceDataToSave[field.id] = input.value;
                        }
                    }
                });
            }

            try {
                await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/services`, appState.currentServiceId), {
                    data: serviceDataToSave,
                    pictures: appState.currentServicePictures, // Save the updated pictures array
                    note: serviceNoteInput.value // Save the note
                });
                console.log("Service details saved successfully.");
                // No showMessageBox here, as it's called after image upload/delete
            } catch (error) {
                console.error("Error saving service details:", error);
                showMessageBox("Failed to save service details.");
            }
        }

        /**
         * Handles deletion of the current service.
         */
        async function handleDeleteService() {
            const confirmed = await showConfirmationBox(`Are you sure you want to delete the "${appState.currentServiceType}" service? This action cannot be undone.`);
            if (confirmed) {
                showLoading();
                try {
                    await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/services`, appState.currentServiceId));
                    showMessageBox("Service deleted successfully!");
                    appState.currentServiceId = null;
                    appState.currentServiceType = null;
                    appState.currentServiceData = {};
                    appState.currentServicePictures = [];
                    showView('services-view'); // Go back to services list
                } catch (error) {
                    console.error("Error deleting service:", error);
                    showMessageBox("Failed to delete service.");
                } finally {
                    hideLoading();
                }
            }
        }

        // --- Asset Management Functions ---

        /**
         * Renders the assets associated with the current site in the modal.
         */
        function renderAssetsInSiteModal() {
            assetsList.innerHTML = '';
            if (appState.currentSiteAssets.length === 0) {
                assetsList.innerHTML = '<p class="text-gray-600 text-center py-4">No assets added yet.</p>';
            }
            appState.currentSiteAssets.forEach((asset, index) => {
                const assetCard = `
                    <div class="bg-gray-100 p-4 rounded-md shadow-sm flex justify-between items-center">
                        <div>
                            <h4 class="text-md font-semibold text-gray-800">${asset.type} (${asset.quantity})</h4>
                            <p class="text-gray-600 text-sm">Location: ${asset.location || 'N/A'}</p>
                            <p class="text-gray-500 text-xs">Criticality: ${asset.criticality || 'N/A'}, Condition: ${asset.condition || 'N/A'}</p>
                        </div>
                        <div class="flex space-x-2">
                            <button type="button" data-index="${index}" class="edit-asset-btn bg-yellow-400 hover:bg-yellow-500 text-white p-2 rounded-md text-sm">Edit</button>
                            <button type="button" data-index="${index}" class="delete-asset-btn bg-red-400 hover:bg-red-500 text-white p-2 rounded-md text-sm">Delete</button>
                        </div>
                    </div>
                `;
                assetsList.insertAdjacentHTML('beforeend', assetCard);
            });

            document.querySelectorAll('.edit-asset-btn').forEach(button => {
                button.onclick = (event) => {
                    const indexToEdit = parseInt(event.currentTarget.dataset.index);
                    appState.currentEditingAssetIndex = indexToEdit;
                    populateAssetModal(appState.currentSiteAssets[indexToEdit]);
                    assetModalTitle.textContent = 'Edit Asset';
                    assetModal.classList.remove('hidden');
                    assetModal.classList.add('flex');
                };
            });

            document.querySelectorAll('.delete-asset-btn').forEach(button => {
                button.onclick = async (event) => {
                    const indexToDelete = parseInt(event.currentTarget.dataset.index);
                    const assetName = appState.currentSiteAssets[indexToDelete].type;
                    const confirmed = await showConfirmationBox(`Are you sure you want to delete the asset "${assetName}"?`);
                    if (confirmed) {
                        deleteAsset(indexToDelete);
                    }
                };
            });
        }

        /**
         * Populates the asset modal with data for editing.
         * @param {object} asset - The asset object to populate the form with.
         */
        function populateAssetModal(asset) {
            assetTypeInput.value = asset.type || '';
            assetQuantityInput.value = asset.quantity || 1;
            assetLocationInput.value = asset.location || '';
            assetCriticalitySelect.value = asset.criticality || '';
            assetConditionSelect.value = asset.condition || '';
            assetManufacturerModelInput.value = asset.manufacturerModel || '';
            assetInstallationDateInput.value = asset.installationDate || '';
            assetLastServiceDateInput.value = asset.lastServiceDate || '';
            assetNextDueDateInput.value = asset.nextDueDate || '';
        }

        /**
         * Handles adding/editing an asset.
         * @param {Event} e - The form submission event.
         */
        async function handleAssetFormSubmit(e) {
            e.preventDefault();
            showLoading();

            const assetData = {
                type: assetTypeInput.value.trim(),
                quantity: parseInt(assetQuantityInput.value),
                location: assetLocationInput.value.trim(),
                criticality: assetCriticalitySelect.value,
                condition: assetConditionSelect.value,
                manufacturerModel: assetManufacturerModelInput.value.trim(),
                installationDate: assetInstallationDateInput.value,
                lastServiceDate: assetLastServiceDateInput.value,
                nextDueDate: assetNextDueDateInput.value
            };

            if (!assetData.type || isNaN(assetData.quantity) || assetData.quantity <= 0) {
                showMessageBox("Please fill in Asset Type and a valid Quantity.");
                hideLoading();
                return;
            }

            if (appState.currentEditingAssetIndex !== null) {
                // Editing existing asset
                appState.currentSiteAssets[appState.currentEditingAssetIndex] = assetData;
                showMessageBox("Asset updated successfully!");
            } else {
                // Adding new asset
                appState.currentSiteAssets.push(assetData);
                showMessageBox("New asset added successfully!");
            }

            renderAssetsInSiteModal(); // Re-render the list in the site modal
            await saveSiteDetailsToFirestore(); // Save the entire site (including assets) to Firestore
            assetModal.classList.add('hidden');
            assetModal.classList.remove('flex');
            assetForm.reset();
            appState.currentEditingAssetIndex = null; // Reset for next operation
            hideLoading();
        }

        /**
         * Deletes an asset from the current site's assets array.
         * @param {number} index - The index of the asset to delete.
         */
        async function deleteAsset(index) {
            showLoading();
            try {
                appState.currentSiteAssets.splice(index, 1);
                renderAssetsInSiteModal(); // Re-render the list in the site modal
                await saveSiteDetailsToFirestore(); // Save the entire site (including assets) to Firestore
                showMessageBox("Asset deleted successfully!");
            } catch (error) {
                console.error("Error deleting asset:", error);
                showMessageBox("Failed to delete asset.");
            } finally {
                hideLoading();
            }
        }

        /**
         * Helper function to save current site details (including assets and pictures) to Firestore.
         * This is called after any modification to assets or pictures within the site modal.
         */
        async function saveSiteDetailsToFirestore() {
            if (!isAuthReady || !appState.currentSiteId) {
                console.warn("Cannot save site details: Not authenticated or no current site selected.");
                return;
            }
            try {
                const siteData = {
                    name: siteNameInput.value.trim(),
                    address: siteAddressInput.value.trim(),
                    totalSqFt: parseFloat(siteTotalSqFtInput.value) || 0,
                    personnelShifts: sitePersonnelShiftsInput.value.trim(),
                    pictures: appState.currentSitePictures,
                    assets: appState.currentSiteAssets, // Ensure assets are saved
                    ppmRmSplitCurrent: ppmRmSplitCurrentInput.value.trim(),
                    ppmRmSplitProposed: ppmRmSplitProposedInput.value.trim(),
                    detailedSLAs: detailedSLAsInput.value.trim(),
                    clientPriorityPainPoints: clientPriorityPainPointsInput.value.trim(),
                    complianceRequirements: complianceRequirementsInput.value.trim()
                };
                await updateDoc(doc(db, `artifacts/${appId}/users/${userId}/sites`, appState.currentSiteId), siteData);
                console.log("Site details (including assets/pictures) saved to Firestore.");
            } catch (error) {
                console.error("Error saving site details to Firestore:", error);
                showMessageBox("Failed to save site details automatically.");
            }
        }

        // --- Event Listeners ---

        // Global message box OK button
        messageBoxOkBtn.onclick = hideMessageBox;

        // Back button navigation
        backButton.onclick = () => {
            if (appState.currentView === 'sites') {
                appState.currentProjectId = null;
                appState.currentProjectName = null;
                showView('projects-view');
            } else if (appState.currentView === 'zones') {
                appState.currentSiteId = null;
                appState.currentSiteName = null;
                appState.currentSitePictures = []; // Clear site pictures state
                appState.currentSiteAssets = []; // Clear site assets state
                loadSites(); // Go back to sites list
            } else if (appState.currentView === 'services') {
                appState.currentZoneId = null;
                appState.currentZoneName = null;
                appState.currentZonePictures = []; // Clear zone pictures state
                loadZones(); // Go back to zones list
            } else if (appState.currentView === 'service-detail') {
                appState.currentServiceId = null;
                appState.currentServiceType = null;
                appState.currentServiceData = {};
                appState.currentServicePictures = [];
                serviceNoteInput.value = ''; // Clear note field
                loadServices(); // Go back to services list
            }
        };

        // Project Modal
        addProjectBtn.onclick = () => {
            projectModalTitle.textContent = 'Add New Quote';
            projectForm.reset();
            appState.currentProjectId = null; // Ensure we're adding, not editing
            clientSubcategoryGroup.classList.add('hidden'); // Hide subcategory initially
            clientSubcategorySelect.innerHTML = '<option value="">Select Subcategory</option>'; // Clear subcategory options
            projectModal.classList.remove('hidden');
            projectModal.classList.add('flex');
        };
        cancelProjectBtn.onclick = () => {
            projectModal.classList.add('hidden');
            projectModal.classList.remove('flex');
        };
        projectForm.onsubmit = handleProjectFormSubmit;

        // Dynamic Subcategory Population
        clientCategorySelect.addEventListener('change', () => {
            populateSubcategories(clientCategorySelect.value);
        });

        function populateSubcategories(selectedCategory, selectedSubcategory = '') {
            clientSubcategorySelect.innerHTML = '<option value="">Select Subcategory</option>'; // Clear existing options

            if (selectedCategory && CLIENT_CATEGORIES[selectedCategory]) {
                CLIENT_CATEGORIES[selectedCategory].forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    clientSubcategorySelect.appendChild(option);
                });
                clientSubcategoryGroup.classList.remove('hidden');
                clientSubcategorySelect.value = selectedSubcategory; // Set pre-selected value
            } else {
                clientSubcategoryGroup.classList.add('hidden');
            }
        }


        // Site Modal
        addSiteBtn.onclick = () => {
            if (!appState.currentProjectId) {
                showMessageBox("Please select a quote first.");
                return;
            }
            siteModalTitle.textContent = 'Add New Site';
            siteForm.reset();
            appState.currentSiteId = null; // Ensure we're adding, not editing
            appState.currentSitePictures = []; // Clear pictures for new site
            appState.currentSiteAssets = []; // Clear assets for new site
            renderSitePicturesInModal(); // Render empty pictures for new site
            renderAssetsInSiteModal(); // Render empty assets for new site
            siteModal.classList.remove('hidden');
            siteModal.classList.add('flex');
        };
        cancelSiteBtn.onclick = () => {
            siteModal.classList.add('hidden');
            siteModal.classList.remove('flex');
            // Reset appState for assets and pictures when cancelling
            appState.currentSitePictures = [];
            appState.currentSiteAssets = [];
            appState.currentEditingAssetIndex = null;
        };
        siteForm.onsubmit = handleSiteFormSubmit;
        siteImageInput.onchange = handleSiteImageUpload;

        // Asset Modal Event Listeners
        addAssetBtn.onclick = () => {
            assetModalTitle.textContent = 'Add New Asset';
            assetForm.reset();
            appState.currentEditingAssetIndex = null; // Ensure we're adding, not editing
            assetModal.classList.remove('hidden');
            assetModal.classList.add('flex');
        };
        cancelAssetBtn.onclick = () => {
            assetModal.classList.add('hidden');
            assetModal.classList.remove('flex');
            assetForm.reset();
            appState.currentEditingAssetIndex = null;
        };
        assetForm.onsubmit = handleAssetFormSubmit;


        // Zone Modal
        addZoneBtn.onclick = () => {
            if (!appState.currentSiteId) {
                showMessageBox("Please select a site first.");
                return;
            }
            zoneModalTitle.textContent = 'Add New Zone';
            zoneForm.reset();
            appState.currentZoneId = null; // Ensure we're adding, not editing
            appState.currentZonePictures = []; // Clear pictures for new zone
            renderZonePicturesInModal(); // Render empty pictures for new zone
            zoneModal.classList.remove('hidden');
            zoneModal.classList.add('flex');
        };
        cancelZoneBtn.onclick = () => {
            zoneModal.classList.add('hidden');
            zoneModal.classList.remove('flex');
        };
        zoneForm.onsubmit = handleZoneFormSubmit;
        zoneImageInput.onchange = handleZoneImageUpload;

        // Service Modal
        addServiceBtn.onclick = () => {
            if (!appState.currentZoneId) {
                showMessageBox("Please select a zone first.");
                return;
            }
            serviceModalTitle.textContent = 'Add New Service';
            serviceForm.reset();
            populateServiceTypeDropdown();
            serviceModal.classList.remove('hidden');
            serviceModal.classList.add('flex');
        };
        cancelServiceBtn.onclick = () => {
            serviceModal.classList.add('hidden');
            serviceModal.classList.remove('flex');
        };
        serviceForm.onsubmit = handleServiceFormSubmit;

        // Service Detail View
        serviceDetailForm.onsubmit = async (e) => {
            e.preventDefault();
            showLoading();
            await saveServiceDetails();
            showMessageBox("Service details updated!");
            hideLoading();
        };
        serviceImageInput.onchange = handleServiceImageUpload;
        deleteServiceBtn.onclick = handleDeleteService;

        // Initial Firebase setup
        initializeFirebase();
    </script>
</body>
</html>
